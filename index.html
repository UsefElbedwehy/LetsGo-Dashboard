<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>LetsGo Dashboard</title>
        
        <!-- Keep using compat version for compatibility -->
        <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
        
        <!-- Chart.js for Analytics -->
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <!-- Tailwind CSS -->
        <script src="https://cdn.tailwindcss.com"></script>
        <!-- Font Awesome -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
        
        <style>
            /* Keep your existing styles */
            :root {
                --primary-color: #3b82f6;
                --secondary-color: #10b981;
                --danger-color: #ef4444;
                --warning-color: #f59e0b;
            }
            
            .sidebar {
                transition: all 0.3s ease;
            }
            
            .dashboard-card {
                transition: transform 0.3s ease, box-shadow 0.3s ease;
            }
            
            .dashboard-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            }
            
            .status-badge {
                padding: 4px 12px;
                border-radius: 20px;
                font-size: 12px;
                font-weight: 600;
            }

            .status-badge {
                padding: 4px 12px;
                border-radius: 20px;
                font-size: 12px;
                font-weight: 600;
                display: inline-flex;
                align-items: center;
            }

            /* Payment status colors */
            .payment-paid { background-color: #d1fae5; color: #065f46; }
            .payment-pending { background-color: #fef3c7; color: #92400e; }
            .payment-cancelled { background-color: #f3f4f6; color: #374151; }
            .payment-failed { background-color: #fee2e2; color: #991b1b; }
            .payment-none { background-color: #f9fafb; color: #6b7280; }

            /* Payment method colors */
            .method-online { background-color: #e0e7ff; color: #3730a3; }
            .method-cash { background-color: #dbeafe; color: #1e40af; }

            /* Trip status icons */
            .status-badge i.fa-route { margin-right: 4px; }
            .status-badge i.fa-check-circle { margin-right: 4px; }
            .status-badge i.fa-clock { margin-right: 4px; }
            .status-badge i.fa-ban { margin-right: 4px; }
            .status-badge i.fa-exclamation-circle { margin-right: 4px; }
            
            .status-requested { background-color: #dbeafe; color: #1d4ed8; }
            .status-accepted { background-color: #fef3c7; color: #d97706; }
            .status-arrived { background-color: #f0f9ff; color: #0369a1; }
            .status-inProgress { background-color: #f0f9ff; color: #0369a1; }
            .status-completed { background-color: #d1fae5; color: #065f46; }
            .status-cancelledByPassenger { background-color: #fee2e2; color: #dc2626; }
            .status-cancelledByDriver { background-color: #fee2e2; color: #dc2626; }
            .status-timeout { background-color: #f5f5f5; color: #6b7280; }
        </style>
    </head>
<body class="bg-gray-50">
    <!-- Firebase Configuration -->
    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyCVdE0BlIpZHNBMufI0INVxTHZIvcDoeho",
          authDomain: "lets-go-cf4af.firebaseapp.com",
          projectId: "lets-go-cf4af",
          storageBucket: "lets-go-cf4af.firebasestorage.app",
          messagingSenderId: "660112178754",
          appId: "1:660112178754:web:e935768f097fab7085b7db",
          measurementId: "G-M6QJ1RHLK1"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
    </script>

    <!-- Main Container -->
    <div class="flex h-screen">
        <!-- Sidebar -->
        <div class="sidebar w-64 bg-white shadow-lg flex flex-col">
            <div class="p-6 border-b">
                <h1 class="text-2xl font-bold text-blue-600">ðŸš• LetsGo</h1>
                <p class="text-gray-500 text-sm mt-1">Admin Dashboard</p>
            </div>
            
            <nav class="flex-1 p-4">
                <ul class="space-y-2">
                    <li>
                        <a href="#dashboard" class="flex items-center p-3 text-gray-700 rounded-lg hover:bg-blue-50 hover:text-blue-600 transition-colors">
                            <i class="fas fa-tachometer-alt w-6"></i>
                            <span class="ml-3">Dashboard</span>
                        </a>
                    </li>
                    <li>
                        <a href="#rides" class="flex items-center p-3 text-gray-700 rounded-lg hover:bg-blue-50 hover:text-blue-600 transition-colors">
                            <i class="fas fa-car w-6"></i>
                            <span class="ml-3">Rides</span>
                            <span id="rides-count" class="ml-auto bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">0</span>
                        </a>
                    </li>
                    <li>
                        <a href="#drivers" class="flex items-center p-3 text-gray-700 rounded-lg hover:bg-blue-50 hover:text-blue-600 transition-colors">
                            <i class="fas fa-user-tie w-6"></i>
                            <span class="ml-3">Drivers</span>
                            <span id="drivers-count" class="ml-auto bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">0</span>
                        </a>
                    </li>
                    <li>
                        <a href="#passengers" class="flex items-center p-3 text-gray-700 rounded-lg hover:bg-blue-50 hover:text-blue-600 transition-colors">
                            <i class="fas fa-users w-6"></i>
                            <span class="ml-3">Passengers</span>
                            <span id="passengers-count" class="ml-auto bg-purple-100 text-purple-800 text-xs px-2 py-1 rounded-full">0</span>
                        </a>
                    </li>
                    
                    <li>
                        <a href="#analytics" class="flex items-center p-3 text-gray-700 rounded-lg hover:bg-blue-50 hover:text-blue-600 transition-colors">
                            <i class="fas fa-chart-line w-6"></i>
                            <span class="ml-3">Analytics</span>
                        </a>
                    </li>
                    <li>
                        <a href="#payments" class="flex items-center p-3 text-gray-700 rounded-lg hover:bg-blue-50 hover:text-blue-600 transition-colors">
                            <i class="fas fa-credit-card w-6"></i>
                            <span class="ml-3">Payments</span>
                            <span id="payments-count" class="ml-auto bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded-full">0</span>
                        </a>
                    </li>
                    <li>
                        <a href="#settings" class="flex items-center p-3 text-gray-700 rounded-lg hover:bg-blue-50 hover:text-blue-600 transition-colors">
                            <i class="fas fa-cog w-6"></i>
                            <span class="ml-3">Settings</span>
                        </a>
                    </li>
                </ul>
            </nav>
            
            <div class="p-4 border-t">
                <div class="flex items-center">
                    <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-user text-blue-600"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm font-medium" id="admin-email">Loading...</p>
                        <button onclick="logout()" class="text-xs text-red-500 hover:text-red-700">Logout</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 overflow-y-auto">
            <!-- Top Bar -->
            <div class="bg-white shadow-sm p-4 border-b">
                <div class="flex justify-between items-center">
                    <h2 id="page-title" class="text-xl font-semibold text-gray-800">Dashboard Overview</h2>
                    <div class="flex items-center space-x-4">
                        <div class="relative">
                            <input type="text" placeholder="Search..." class="pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                        </div>
                        <div class="text-sm text-gray-500" id="current-time">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Dashboard Content -->
            <div class="p-6" id="content-area">
                <!-- Dashboard Overview Section -->
                <div id="dashboard-section">
                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="dashboard-card bg-white rounded-xl shadow p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-500 text-sm">Total Rides</p>
                                    <p class="text-3xl font-bold mt-2" id="total-rides">0</p>
                                </div>
                                <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-car text-blue-600 text-xl"></i>
                                </div>
                            </div>
                            <div class="mt-4">
                                <span class="text-green-500 text-sm" id="rides-change">
                                    <i class="fas fa-arrow-up"></i> 0% from last week
                                </span>
                            </div>
                        </div>

                        <div class="dashboard-card bg-white rounded-xl shadow p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-500 text-sm">Active Drivers</p>
                                    <p class="text-3xl font-bold mt-2" id="active-drivers">0</p>
                                </div>
                                <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-user-tie text-green-600 text-xl"></i>
                                </div>
                            </div>
                            <div class="mt-4">
                                <span class="text-green-500 text-sm" id="drivers-change">
                                    <i class="fas fa-arrow-up"></i> 0% from last week
                                </span>
                            </div>
                        </div>

                        <div class="dashboard-card bg-white rounded-xl shadow p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-500 text-sm">Revenue</p>
                                    <p class="text-3xl font-bold mt-2" id="total-revenue">$0</p>
                                </div>
                                <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-dollar-sign text-purple-600 text-xl"></i>
                                </div>
                            </div>
                            <div class="mt-4">
                                <span class="text-green-500 text-sm" id="revenue-change">
                                    <i class="fas fa-arrow-up"></i> 0% from last week
                                </span>
                            </div>
                        </div>

                        <div class="dashboard-card bg-white rounded-xl shadow p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-500 text-sm">Completion Rate</p>
                                    <p class="text-3xl font-bold mt-2" id="completion-rate">0%</p>
                                </div>
                                <div class="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-chart-line text-orange-600 text-xl"></i>
                                </div>
                            </div>
                            <div class="mt-4">
                                <span class="text-green-500 text-sm" id="completion-change">
                                    <i class="fas fa-arrow-up"></i> 0% from last week
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Charts and Tables -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        <!-- Ride Status Chart -->
                        <div class="bg-white rounded-xl shadow p-6">
                            <h3 class="text-lg font-semibold mb-4">Ride Status Distribution</h3>
                            <div class="h-64">
                                <canvas id="rideStatusChart"></canvas>
                            </div>
                        </div>

                        <!-- Recent Rides -->
                        <div class="bg-white rounded-xl shadow p-6">
                            <h3 class="text-lg font-semibold mb-4">Recent Rides</h3>
                            <div class="overflow-x-auto">
                                <table class="min-w-full">
                                    <thead>
                                        <tr class="border-b">
                                            <th class="text-left py-3 text-gray-600">ID</th>
                                            <th class="text-left py-3 text-gray-600">Status</th>
                                            <th class="text-left py-3 text-gray-600">Fare</th>
                                            <th class="text-left py-3 text-gray-600">Time</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recent-rides-table">
                                        <!-- Rides will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <!-- Add this to your dashboard-section after the existing charts section -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        <!-- Payment Analytics Chart -->
                        <div class="bg-white rounded-xl shadow p-6">
                            <h3 class="text-lg font-semibold mb-4">Payment Analytics</h3>
                            <div class="h-64">
                                <canvas id="paymentChart"></canvas>
                            </div>
                        </div>

                        <!-- Payment Statistics -->
                        <div class="bg-white rounded-xl shadow p-6">
                            <h3 class="text-lg font-semibold mb-4">Payment Statistics</h3>
                            <div class="space-y-4">
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600">Total Payments</span>
                                    <span class="font-bold" id="total-payments">0</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600">Successful Payments</span>
                                    <span class="font-bold text-green-600" id="successful-payments">0</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600">Pending Payments</span>
                                    <span class="font-bold text-yellow-600" id="pending-payments">0</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600">Success Rate</span>
                                    <span class="font-bold text-blue-600" id="payment-success-rate">0%</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600">Total Revenue</span>
                                    <span class="font-bold text-purple-600" id="total-revenue-detailed">$0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Rides Management Section -->
                <div id="rides-section" style="display: none;">
                    <div class="bg-white rounded-xl shadow p-6 mb-8">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-semibold">All Rides</h3>
                            <div class="flex space-x-2">
                                <select id="status-filter" class="border rounded-lg px-3 py-2">
                                    <option value="">All Status</option>
                                    <option value="requested">Requested</option>
                                    <option value="accepted">Accepted</option>
                                    <option value="arrived">Arrived</option>
                                    <option value="inProgress">In Progress</option>
                                    <option value="completed">Completed</option>
                                    <option value="cancelledByPassenger">Cancelled by Passenger</option>
                                    <option value="cancelledByDriver">Cancelled by Driver</option>
                                    <option value="timeout">Timeout</option>
                                </select>
                                <input type="date" id="date-filter" class="border rounded-lg px-3 py-2">
                                <button onclick="exportRides()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">
                                    <i class="fas fa-download mr-2"></i>Export
                                </button>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full">
                                <thead>
                                    <tr class="border-b">
                                        <th class="text-left py-3 text-gray-600">Ride ID</th>
                                        <th class="text-left py-3 text-gray-600">Passenger</th>
                                        <th class="text-left py-3 text-gray-600">Driver</th>
                                        <th class="text-left py-3 text-gray-600">Status</th>
                                        <th class="text-left py-3 text-gray-600">Fare</th>
                                        <th class="text-left py-3 text-gray-600">Distance</th>
                                        <th class="text-left py-3 text-gray-600">Date</th>
                                        <th class="text-left py-3 text-gray-600">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="rides-table">
                                    <!-- Rides will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-4 flex justify-between items-center">
                            <div class="text-sm text-gray-500" id="rides-info">Showing 0 rides</div>
                            <div class="flex space-x-2">
                                <button onclick="previousPage()" class="px-3 py-1 border rounded hover:bg-gray-50">Previous</button>
                                <span id="current-page" class="px-3 py-1">1</span>
                                <button onclick="nextPage()" class="px-3 py-1 border rounded hover:bg-gray-50">Next</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Passengers Management Section -->
                <div id="passengers-section" style="display: none;">
                    <div class="bg-white rounded-xl shadow p-6 mb-8">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-semibold">Passengers Management</h3>
                            <div class="flex space-x-2">
                                <input type="text" id="passenger-search" placeholder="Search by name or email..."
                                       class="border rounded-lg px-3 py-2 w-64 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full">
                                <thead>
                                    <tr class="border-b">
                                        <th class="text-left py-3 text-gray-600">Passenger</th>
                                        <th class="text-left py-3 text-gray-600">Email</th>
                                        <th class="text-left py-3 text-gray-600">Phone</th>
                                        <th class="text-left py-3 text-gray-600">Status</th>
                                        <th class="text-left py-3 text-gray-600">Rides</th>
                                        <th class="text-left py-3 text-gray-600">Joined</th>
                                        <th class="text-left py-3 text-gray-600">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="passengers-table">
                                    <!-- Passengers will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Drivers Management Section -->
                <div id="drivers-section" style="display: none;">
                    <div class="bg-white rounded-xl shadow p-6 mb-8">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-semibold">Drivers Management</h3>
                            <div class="flex space-x-2">
                                <input type="text" id="driver-search" placeholder="Search drivers..."
                                       class="border rounded-lg px-3 py-2 w-64 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <select id="driver-status-filter" class="border rounded-lg px-3 py-2">
                                    <option value="">All Status</option>
                                    <option value="active">Active</option>
                                    <option value="inactive">Inactive</option>
                                    <option value="verified">Verified</option>
                                    <option value="pending">Pending Verification</option>
                                </select>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full">
                                <thead>
                                    <tr class="border-b">
                                        <th class="text-left py-3 text-gray-600">Driver ID</th>
                                        <th class="text-left py-3 text-gray-600">Driver</th>
                                        <th class="text-left py-3 text-gray-600">Vehicle</th>
                                        <th class="text-left py-3 text-gray-600">Location</th>
                                        <th class="text-left py-3 text-gray-600">Rating</th>
                                        <th class="text-left py-3 text-gray-600">Status</th>
                                        <th class="text-left py-3 text-gray-600">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="drivers-table">
                                    <!-- Drivers will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Payments Section -->
                <div id="payments-section" style="display: none;">
                    <div class="bg-white rounded-xl shadow p-6 mb-8">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-semibold">Payment Management</h3>
                            <div class="flex space-x-2">
                                <select id="payment-status-filter" class="border rounded-lg px-3 py-2">
                                    <option value="">All Status</option>
                                    <option value="paid">Paid/CAPTURED</option>
                                    <option value="pending">Pending</option>
                                    <option value="cancelled">Cancelled</option>
                                    <option value="failed">Failed</option>
                                </select>
                                <input type="date" id="payment-date-filter" class="border rounded-lg px-3 py-2">
                                <button onclick="dashboard.viewAllPayments()" class="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600">
                                    <i class="fas fa-eye mr-2"></i>View All
                                </button>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <p class="text-sm text-blue-600">Total Payments</p>
                                <p class="text-2xl font-bold" id="payments-total">0</p>
                            </div>
                            <div class="bg-green-50 p-4 rounded-lg">
                                <p class="text-sm text-green-600">Successful</p>
                                <p class="text-2xl font-bold" id="payments-successful">0</p>
                            </div>
                            <div class="bg-yellow-50 p-4 rounded-lg">
                                <p class="text-sm text-yellow-600">Pending</p>
                                <p class="text-2xl font-bold" id="payments-pending">0</p>
                            </div>
                            <div class="bg-red-50 p-4 rounded-lg">
                                <p class="text-sm text-red-600">Cancelled/Failed</p>
                                <p class="text-2xl font-bold" id="payments-failed">0</p>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full">
                                <thead>
                                    <tr class="border-b">
                                        <th class="text-left py-3 text-gray-600">Payment ID</th>
                                        <th class="text-left py-3 text-gray-600">User</th>
                                        <th class="text-left py-3 text-gray-500">Amount</th>
                                        <th class="text-left py-3 text-gray-600">Status</th>
                                        <th class="text-left py-3 text-gray-600">Provider</th>
                                        <th class="text-left py-3 text-gray-600">Date</th>
                                        <th class="text-left py-3 text-gray-600">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="payments-table">
                                    <!-- Payments will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Settings Section -->
                <div id="settings-section" style="display: none;">
                    <div class="bg-white rounded-xl shadow p-6">
                        <h3 class="text-lg font-semibold mb-6">App Configuration</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h4 class="font-medium mb-4">Supported Countries</h4>
                                <div id="supported-countries" class="space-y-2">
                                    <!-- Countries will be loaded here -->
                                </div>
                            </div>
                            <div>
                                <h4 class="font-medium mb-4">App Settings</h4>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Last Updated</label>
                                        <p id="last-updated" class="text-gray-600">Loading...</p>
                                    </div>
                                    <div>
                                        <button onclick="refreshAppConfig()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                                            <i class="fas fa-sync-alt mr-2"></i>Refresh Configuration
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ride Details Modal -->
    <div id="ride-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-semibold">Ride Details</h3>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div id="ride-details-content">
                    <!-- Ride details will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Data Management
        class DashboardManager {
            constructor() {
                this.rides = [];
                this.drivers = [];
                this.passengers = [];
                this.ridePayments = []; // Add this line
                this.appConfig = null;
                this.currentPage = 1;
                this.pageSize = 10;
                this.rideChart = null;
                this.isLoading = false;
                this.rideTypes = [];
            }
            
            async initialize() {
                try {
                    await this.setupAuth();
                    console.log('Auth setup complete');
                    
                    await this.loadAllData();
                    console.log('Data loaded successfully');
                    
                    this.setupEventListeners();
                    this.updateTime();
                    setInterval(() => this.updateTime(), 60000);
                    
                    // Show dashboard by default
                    this.showSection('dashboard');
                    
                    this.showNotification('Dashboard loaded successfully');
                } catch (error) {
                    console.error('Initialization error:', error);
                    this.showNotification(`Error loading dashboard: ${error.message}`, 'error');
                    
                    // Still show dashboard section even if data fails
                    this.showSection('dashboard');
                }
            }

            async setupAuth() {
                document.getElementById('admin-email').textContent = 'admin@letsgo.com';
            }

            async loadAllData() {
                try {
                    console.log('Starting to load all data...');
                    
                    // Load ride types first (smallest dataset)
                    console.log('Loading ride types...');
                    await this.loadRideTypes();
                    console.log('Ride types loaded');
                    
                    // Then load other data in parallel for better performance
                    console.log('Loading main data...');
                    await Promise.all([
                        this.loadRideRequests(),
                        this.loadRidePayments(),
                        this.loadDrivers(),
                        this.loadPassengers(),
                        this.loadAppConfig()
                    ]);
                    
                    console.log('Data loaded:');
                    console.log('- Rides:', this.rides ? this.rides.length : 0);
                    console.log('- Ride Payments:', this.ridePayments ? this.ridePayments.length : 0);
                    console.log('- Drivers:', this.drivers ? this.drivers.length : 0);
                    console.log('- Passengers:', this.passengers ? this.passengers.length : 0);
                    console.log('- Ride Types:', this.rideTypes ? this.rideTypes.length : 0);
                    
                    // Enrich rides with payment data
                    this.enrichRidesWithPayments();
                    
                    this.updateDashboardStats();
                    this.renderRecentRides();
                    this.renderRidesTable();
                    this.renderDriversTable();
                    this.renderPassengersTable();
                    this.renderSupportedCountries();
                    this.initCharts();
                    
                    console.log('All data loaded successfully');
                    
                } catch (error) {
                    console.error('Error loading data:', error);
                    this.showNotification('Error loading data: ' + error.message, 'error');
                }
            }

            async loadRideRequests() {
                try {
                    console.log('Loading ride requests...');
                    const snapshot = await db.collection('rideRequests')
                        .orderBy('createdAt', 'desc')
                        .get();
                    
                    this.rides = snapshot.docs.map(doc => {
                        const data = doc.data();
                        return {
                            id: doc.id,
                            ...data,
                            createdAt: data.createdAt ? data.createdAt.toDate() : null,
                            updatedAt: data.updatedAt ? data.updatedAt.toDate() : null,
                            acceptedAt: data.acceptedAt ? data.acceptedAt.toDate() : null,
                            cancelledAt: data.cancelledAt ? data.cancelledAt.toDate() : null,
                            // Initialize payment fields that will be populated later
                            paymentData: null,
                            paymentStatus: null,
                            paymentAmount: null,
                            paymentMethod: null,
                            tapChargeId: null,
                            tapStatus: null
                        };
                    });
                    
                    console.log(`Loaded ${this.rides.length} ride requests`);
                    document.getElementById('rides-count').textContent = this.rides.length;
                    
                } catch (error) {
                    console.error('Error loading ride requests:', error);
                    throw error;
                }
            }

            async loadRidePayments() {
                try {
                    console.log('Loading ride payments...');
                    const snapshot = await db.collection('ridePayments')
                        .orderBy('createdAt', 'desc')
                        .get();
                    
                    this.ridePayments = snapshot.docs.map(doc => {
                        const data = doc.data();
                        return {
                            id: doc.id,
                            ...data,
                            createdAt: data.createdAt ? data.createdAt.toDate() : null,
                            updatedAt: data.updatedAt ? data.updatedAt.toDate() : null,
                            paidAt: data.paidAt ? data.paidAt.toDate() : null,
                            // Ensure all payment fields are present
                            baseAmount: data.baseAmount || 0,
                            lockedAmount: data.lockedAmount || 0,
                            currency: data.currency || 'N/A',
                            paymentProvider: data.paymentProvider || 'N/A',
                            status: data.status || data.tapStatus || 'pending',
                            tapStatus: data.tapStatus || 'N/A',
                            tapChargeId: data.tapChargeId || 'N/A',
                            userId: data.userId || 'N/A',
                            cityId: data.cityId || 'N/A',
                            countryCode: data.countryCode || 'N/A',
                            purpose: data.purpose || 'N/A',
                            ridePreview: data.ridePreview || null,
                            tapTransactionUrl: data.tapTransactionUrl || null
                        };
                    });
                    
                    console.log(`Loaded ${this.ridePayments.length} ride payments`);
                    
                } catch (error) {
                    console.error('Error loading ride payments:', error);
                    throw error;
                }
            }

                async loadRideTypes() {
                        try {
                            console.log('Loading ride types...');
                            const snapshot = await db.collection('rideTypes').get();
                            
                            this.rideTypes = snapshot.docs.map(doc => {
                                const data = doc.data();
                                return {
                                    id: doc.id,
                                    ...data
                                };
                            });
                            
                            console.log(`Loaded ${this.rideTypes.length} ride types`);
                            
                        } catch (error) {
                            console.error('Error loading ride types:', error);
                            this.rideTypes = []; // Set empty array on error
                        }
                    }
                
                enrichRidesWithPayments() {
                    console.log('Enriching rides with payment data...');
                    
                    // Create a map of ride payments by userId for quick lookup
                    const paymentsByUserId = {};
                    this.ridePayments.forEach(payment => {
                        if (payment.userId) {
                            if (!paymentsByUserId[payment.userId]) {
                                paymentsByUserId[payment.userId] = [];
                            }
                            paymentsByUserId[payment.userId].push(payment);
                        }
                    });
                    
                    // Enrich each ride with payment data
                    this.rides.forEach(ride => {
                        // Reset payment data
                        ride.paymentData = null;
                        ride.paymentStatus = 'not_paid';
                        ride.paymentAmount = 0;
                        ride.paymentMethod = 'unknown';
                        ride.tapChargeId = null;
                        ride.tapStatus = null;
                        ride.paymentId = null;
                        
                        // If ride has a riderId, try to find matching payments
                        if (ride.riderId && paymentsByUserId[ride.riderId]) {
                            const userPayments = paymentsByUserId[ride.riderId];
                            
                            // Sort payments by creation date (newest first)
                            userPayments.sort((a, b) => b.createdAt - a.createdAt);
                            
                            // Try to find the most relevant payment for this ride
                            let matchedPayment = null;
                            
                            // First try: Match by ride creation time (within 10 minutes)
                            const rideTime = ride.createdAt;
                            if (rideTime) {
                                matchedPayment = userPayments.find(payment => {
                                    const paymentTime = payment.createdAt;
                                    if (!paymentTime) return false;
                                    
                                    // Check if payment was created within 10 minutes of ride
                                    const timeDiff = Math.abs(rideTime.getTime() - paymentTime.getTime());
                                    return timeDiff < 10 * 60 * 1000; // 10 minutes
                                });
                            }
                            
                            // Second try: If no time match, take the most recent payment for this user
                            if (!matchedPayment && userPayments.length > 0) {
                                matchedPayment = userPayments[0];
                            }
                            
                            // If we found a payment, enrich the ride
                            if (matchedPayment) {
                                ride.paymentData = matchedPayment;
                                ride.paymentStatus = matchedPayment.status || matchedPayment.tapStatus || 'pending';
                                ride.paymentAmount = matchedPayment.baseAmount || matchedPayment.lockedAmount || 0;
                                ride.paymentMethod = matchedPayment.paymentProvider || 'online';
                                ride.tapChargeId = matchedPayment.tapChargeId;
                                ride.tapStatus = matchedPayment.tapStatus;
                                ride.paymentId = matchedPayment.id;
                                
                                // Special case: Check if payment is for this specific ride by comparing coordinates
                                if (matchedPayment.ridePreview && ride.pickupLocation && ride.dropoffLocation) {
                                    const paymentPickupLat = matchedPayment.ridePreview.pickup?.lat;
                                    const paymentPickupLng = matchedPayment.ridePreview.pickup?.lng;
                                    const ridePickupLat = ride.pickupLocation.lat || ride.pickupLocation.latitude;
                                    const ridePickupLng = ride.pickupLocation.lng || ride.pickupLocation.longitude;
                                    
                                    // If coordinates are very close, mark as exact match
                                    if (paymentPickupLat && paymentPickupLng && ridePickupLat && ridePickupLng) {
                                        const latDiff = Math.abs(paymentPickupLat - ridePickupLat);
                                        const lngDiff = Math.abs(paymentPickupLng - ridePickupLng);
                                        
                                        if (latDiff < 0.001 && lngDiff < 0.001) {
                                            ride.paymentMatchType = 'exact';
                                        } else {
                                            ride.paymentMatchType = 'user_based';
                                        }
                                    }
                                }
                            }
                        }
                    });
                    
                    // Log matching statistics
                    const ridesWithPayment = this.rides.filter(r => r.paymentData).length;
                    console.log(`Payment enrichment complete: ${ridesWithPayment}/${this.rides.length} rides have payment data`);
                }
            async loadAllDriversAndPassengers() {
                try {
                    // First, get all user documents from letsGoUser collection
                    const usersSnapshot = await db.collection('letsGoUser').get();
                    this.allUsers = [];
                    
                    // Process each user to check for driver/passenger subcollections
                    for (const userDoc of usersSnapshot.docs) {
                        const userId = userDoc.id;
                        const userData = userDoc.data();
                        
                        // Check if this user has a driver subcollection
                        const driverSnapshot = await db.collection('letsGoUser')
                            .doc(userId)
                            .collection('driver')
                            .get();
                        
                        if (!driverSnapshot.empty) {
                            const driverData = driverSnapshot.docs[0].data();
                            this.drivers.push({
                                id: userId,
                                userData: userData,
                                ...driverData,
                                created_at: driverData.created_at?.toDate(),
                                updated_at: driverData.updated_at?.toDate()
                            });
                        }
                        
                        // Check if this user has a passenger subcollection
                        const passengerSnapshot = await db.collection('letsGoUser')
                            .doc(userId)
                            .collection('passenger')
                            .get();
                        
                        if (!passengerSnapshot.empty) {
                            const passengerData = passengerSnapshot.docs[0].data();
                            this.passengers.push({
                                id: userId,
                                userData: userData,
                                ...passengerData,
                                created_at: passengerData.created_at?.toDate(),
                                updated_at: passengerData.updated_at?.toDate()
                            });
                        }
                        
                        // Store user info for reference
                        this.allUsers.push({
                            id: userId,
                            ...userData,
                            created_at: userData.created_at?.toDate(),
                            updated_at: userData.updated_at?.toDate()
                        });
                    }
                    
                    console.log(`Found ${this.drivers.length} drivers and ${this.passengers.length} passengers`);
                    document.getElementById('drivers-count').textContent = this.drivers.length;
                    document.getElementById('passengers-count').textContent = this.passengers.length;
                    
                } catch (error) {
                    console.error('Error loading drivers and passengers:', error);
                    this.showNotification('Error loading users data', 'error');
                }
            }

            async loadRides() {
                    try {
                        console.log('Loading rides...');
                        const snapshot = await db.collection('rideRequests')
                            .orderBy('createdAt', 'desc')
                            .get();
                        
                        this.rides = snapshot.docs.map(doc => {
                            const data = doc.data();
                            return {
                                id: doc.id,
                                ...data,
                                createdAt: data.createdAt ? data.createdAt.toDate() : null,
                                updatedAt: data.updatedAt ? data.updatedAt.toDate() : null
                            };
                        });
                        
                        console.log(`Loaded ${this.rides.length} rides`);
                        document.getElementById('rides-count').textContent = this.rides.length;
                        
                    } catch (error) {
                        console.error('Error loading rides:', error);
                        throw error;
                    }
                }

            async loadDrivers() {
                    try {
                        console.log('Loading drivers...');
                        this.drivers = [];
                        
                        // Get all users from letsGoUser collection
                        const usersSnapshot = await db.collection('letsGoUser').get();
                        console.log(`Found ${usersSnapshot.docs.length} total users`);
                        
                        // Process each user
                        for (const userDoc of usersSnapshot.docs) {
                            const userId = userDoc.id;
                            const userData = userDoc.data();
                            
                            // Check if this user has a driver subcollection
                            try {
                                const driverSnapshot = await db.collection('letsGoUser')
                                    .doc(userId)
                                    .collection('driver')
                                    .get();
                                
                                if (!driverSnapshot.empty) {
                                    const driverData = driverSnapshot.docs[0].data();
                                    
                                    // Get driver's rides
                                    const driverRides = this.rides.filter(ride => ride.driverId === userId);
                                    const completedRides = driverRides.filter(ride => ride.status === 'completed').length;
                                    const totalEarnings = driverRides
                                        .filter(ride => ride.status === 'completed' && ride.finalFare)
                                        .reduce((sum, ride) => sum + (ride.finalFare || 0), 0);
                                    
                                    // Create combined driver object
                                    const driver = {
                                        id: userId,
                                        // User-level data
                                        email: userData.email || '',
                                        phone: userData.phone || '',
                                        fcmToken: userData.fcmToken || '',
                                        role: userData.role || 'driver',
                                        user_is_active: userData.is_active !== undefined ? userData.is_active : true,
                                        user_created_at: userData.created_at ? userData.created_at.toDate() : null,
                                        user_updated_at: userData.updated_at ? userData.updated_at.toDate() : null,
                                        
                                        // Driver-specific data
                                        ...driverData,
                                        driver_created_at: driverData.created_at ? driverData.created_at.toDate() : null,
                                        driver_updated_at: driverData.updated_at ? driverData.updated_at.toDate() : null,
                                        
                                        // Combined fields for easy access
                                        full_name: `${driverData.first_name || ''} ${driverData.last_name || ''}`.trim() ||
                                                   `${userData.first_name || ''} ${userData.last_name || ''}`.trim(),
                                        display_email: driverData.driver_email || userData.email || '',
                                        display_phone: driverData.phone_number || userData.phone || '',
                                        is_active_combined: driverData.is_active !== undefined ? driverData.is_active :
                                                          (userData.is_active !== undefined ? userData.is_active : true),
                                        
                                        // Performance metrics
                                        total_rides: driverRides.length,
                                        completed_rides: completedRides,
                                        total_earnings: totalEarnings,
                                        rating: driverData.rating || 0
                                    };
                                    
                                    this.drivers.push(driver);
                                }
                            } catch (subcollectionError) {
                                console.warn(`Error checking driver subcollection for user ${userId}:`, subcollectionError);
                            }
                        }
                        
                        console.log(`Total drivers found: ${this.drivers.length}`);
                        document.getElementById('drivers-count').textContent = this.drivers.length;
                        
                    } catch (error) {
                        console.error('Error in loadDrivers:', error);
                        throw error;
                    }
                }

                async loadPassengers() {
                    try {
                        console.log('Loading passengers...');
                        this.passengers = [];
                        
                        // Get all users from letsGoUser collection
                        const usersSnapshot = await db.collection('letsGoUser').get();
                        console.log(`Found ${usersSnapshot.docs.length} total users for passenger check`);
                        
                        // Process each user
                        for (const userDoc of usersSnapshot.docs) {
                            const userId = userDoc.id;
                            const userData = userDoc.data();
                            
                            // Check if this user has a passenger subcollection
                            try {
                                const passengerSnapshot = await db.collection('letsGoUser')
                                    .doc(userId)
                                    .collection('passenger')
                                    .get();
                                
                                if (!passengerSnapshot.empty) {
                                    const passengerData = passengerSnapshot.docs[0].data();
                                    
                                    // Get passenger's rides and payment data
                                    const passengerRides = this.rides.filter(ride => ride.riderId === userId);
                                    const passengerPayments = this.ridePayments.filter(payment => payment.userId === userId);
                                    const totalSpent = passengerPayments
                                        .filter(payment => payment.status === 'paid' || payment.tapStatus === 'CAPTURED')
                                        .reduce((sum, payment) => sum + (payment.baseAmount || payment.lockedAmount || 0), 0);
                                    
                                    // Create combined passenger object
                                    const passenger = {
                                        id: userId,
                                        // User-level data
                                        email: userData.email || '',
                                        phone: userData.phone || '',
                                        fcmToken: userData.fcmToken || '',
                                        role: userData.role || 'passenger',
                                        user_is_active: userData.is_active !== undefined ? userData.is_active : true,
                                        user_created_at: userData.created_at ? userData.created_at.toDate() : null,
                                        user_updated_at: userData.updated_at ? userData.updated_at.toDate() : null,
                                        
                                        // Passenger-specific data
                                        ...passengerData,
                                        passenger_created_at: passengerData.created_at ? passengerData.created_at.toDate() : null,
                                        passenger_updated_at: passengerData.updated_at ? passengerData.updated_at.toDate() : null,
                                        
                                        // Combined fields for easy access
                                        full_name: `${passengerData.first_name || ''} ${passengerData.last_name || ''}`.trim() ||
                                                   `${userData.first_name || ''} ${userData.last_name || ''}`.trim() ||
                                                   passengerData.name || '',
                                        avatar: passengerData.avatar || '',
                                        is_active_combined: passengerData.is_active !== undefined ? passengerData.is_active :
                                                          (userData.is_active !== undefined ? userData.is_active : true),
                                        
                                        // Statistics
                                        total_rides: passengerRides.length,
                                        total_spent: totalSpent,
                                        payment_count: passengerPayments.length
                                    };
                                    
                                    this.passengers.push(passenger);
                                }
                            } catch (subcollectionError) {
                                console.warn(`Error checking passenger subcollection for user ${userId}:`, subcollectionError);
                            }
                        }
                        
                        console.log(`Total passengers found: ${this.passengers.length}`);
                        document.getElementById('passengers-count').textContent = this.passengers.length;
                        
                    } catch (error) {
                        console.error('Error in loadPassengers:', error);
                        throw error;
                    }
                }

                async loadAppConfig() {
                        try {
                            console.log('Loading app config...');
                            const doc = await db.collection('general').doc('appConfig').get();
                            
                            if (doc.exists) {
                                this.appConfig = doc.data();
                                console.log('App config loaded');
                            } else {
                                console.log('No app config found');
                                this.appConfig = null;
                            }
                        } catch (error) {
                            console.error('Error loading app config:', error);
                            this.appConfig = null;
                        }
                    }
                   
            
            async verifyDriver(driverId, isCurrentlyVerified) {
                    if (confirm(`Are you sure you want to ${isCurrentlyVerified ? 'unverify' : 'verify'} this driver?`)) {
                        try {
                            await db.collection('letsGoUser').doc(driverId)
                                .collection('driver').doc(driverId)
                                .update({
                                    is_registeration_completed: !isCurrentlyVerified,
                                    updated_at: firebase.firestore.FieldValue.serverTimestamp()
                                });
                            
                            this.showNotification(`Driver ${isCurrentlyVerified ? 'unverified' : 'verified'} successfully`);
                            await this.loadDrivers();
                            this.renderDriversTable();
                        } catch (error) {
                            console.error('Error updating driver verification:', error);
                            this.showNotification('Error updating driver verification', 'error');
                        }
                    }
                }

            async viewDriverRides(driverId) {
                    const driverRides = this.rides.filter(ride => ride.driverId === driverId);
                    const driver = this.drivers.find(d => d.id === driverId);
                    
                    const content = document.getElementById('ride-details-content');
                    content.innerHTML = `
                        <div class="space-y-4">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="text-xl font-semibold">All Rides for ${driver.full_name || 'Unknown Driver'}</h4>
                                <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full">${driverRides.length} rides</span>
                            </div>
                            
                            <div class="overflow-y-auto max-h-[60vh]">
                                <table class="min-w-full">
                                    <thead class="sticky top-0 bg-white">
                                        <tr class="border-b">
                                            <th class="text-left py-2 text-gray-600">Date</th>
                                            <th class="text-left py-2 text-gray-600">From â†’ To</th>
                                            <th class="text-left py-2 text-gray-600">Status</th>
                                            <th class="text-left py-2 text-gray-600">Fare</th>
                                            <th class="text-left py-2 text-gray-600">Distance</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${driverRides.map(ride => `
                                            <tr class="border-b hover:bg-gray-50">
                                                <td class="py-3 text-sm">${this.formatDate(ride.createdAt)}</td>
                                                <td class="py-3">
                                                    <div class="text-sm">
                                                        <div class="truncate max-w-[150px]" title="${ride.pickupLocation?.address || 'N/A'}">
                                                            ${ride.pickupLocation?.address?.substring(0, 30) || 'Pickup'}...
                                                        </div>
                                                        <div class="truncate max-w-[150px]" title="${ride.dropoffLocation?.address || 'N/A'}">
                                                            ${ride.dropoffLocation?.address?.substring(0, 30) || 'Dropoff'}...
                                                        </div>
                                                    </div>
                                                </td>
                                                <td class="py-3">
                                                    <span class="status-badge status-${ride.status}">
                                                        ${this.getStatusText(ride.status)}
                                                    </span>
                                                </td>
                                                <td class="py-3 font-medium">$${ride.finalFare ? ride.finalFare.toFixed(2) : '0.00'}</td>
                                                <td class="py-3">${(ride.distance / 1000).toFixed(1)} km</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                    
                    document.querySelector('#ride-modal h3').textContent = 'Driver Rides';
                    document.getElementById('ride-modal').classList.remove('hidden');
                }


                                                formatCurrency(amount, currencyCode) {
                                                    if (!currencyCode) currencyCode = 'SAR';
                                                    
                                                    // Common currency symbols
                                                    const currencySymbols = {
                                                        'USD': '$',
                                                        'EUR': 'â‚¬',
                                                        'GBP': 'Â£',
                                                        'EGP': 'EÂ£',
                                                        'SAR': 'ï·¼',
                                                        'AED': 'Ø¯.Ø¥',
                                                        'QAR': 'ï·¼',
                                                        'KWD': 'Ø¯.Ùƒ'
                                                    };
                                                    
                                                    // Format number with proper decimal places
                                                    const formattedAmount = amount.toFixed(2);
                                                    
                                                    // Get symbol or use code as fallback
                                                    const symbol = currencySymbols[currencyCode] || currencyCode;
                                                    
                                                    // Some currencies put symbol after amount
                                                    const symbolAfter = ['EGP', 'SAR', 'AED', 'QAR', 'KWD'].includes(currencyCode);
                                                    
                                                    return symbolAfter ? `${formattedAmount} ${symbol}` : `${symbol}${formattedAmount}`;
                                                }
                                                
                                                async sendMessageToDriver(driverId, driverEmail) {
                                                        const subject = prompt('Enter message subject:', 'Message from LetsGo Admin');
                                                        if (!subject) return;
                                                        
                                                        const message = prompt('Enter your message to the driver:');
                                                        if (!message) return;
                                                        
                                                        this.showNotification(`Message sent to ${driverEmail}`);
                                                        
                                                        try {
                                                            await db.collection('adminMessages').add({
                                                                driverId: driverId,
                                                                driverEmail: driverEmail,
                                                                subject: subject,
                                                                message: message,
                                                                sentAt: firebase.firestore.FieldValue.serverTimestamp(),
                                                                sentBy: 'admin'
                                                            });
                                                        } catch (error) {
                                                            console.error('Error saving message:', error);
                                                        }
                                                    }

                                                updateDashboardStats() {
                                                    console.log('Updating dashboard stats...');
                                                    
                                                    // Total Rides
                                                    document.getElementById('total-rides').textContent = this.rides.length;
                                                    
                                                    // Active Drivers
                                                    const activeDrivers = this.drivers.filter(d => d.is_active_combined === true);
                                                    document.getElementById('active-drivers').textContent = activeDrivers.length;
                                                    
                                                    // Total Revenue from Completed Rides with Successful Payments
                                                    const completedRides = this.rides.filter(ride => ride.status === 'completed');
                                                    const successfulPayments = this.ridePayments.filter(payment =>
                                                        payment.status === 'paid' || payment.tapStatus === 'CAPTURED'
                                                    );
                                                    
                                                    // Calculate total revenue from successful payments with correct currency formatting
                                                    const totalRevenue = successfulPayments.reduce((sum, payment) => {
                                                        return sum + (payment.baseAmount || payment.lockedAmount || 0);
                                                    }, 0);
                                                    
                                                    // Get the most common currency or default to first payment's currency
                                                    let defaultCurrency = 'USD';
                                                    if (successfulPayments.length > 0) {
                                                        // Count currency frequencies
                                                        const currencyCounts = {};
                                                        successfulPayments.forEach(payment => {
                                                            const currency = payment.currency || 'USD';
                                                            currencyCounts[currency] = (currencyCounts[currency] || 0) + 1;
                                                        });
                                                        
                                                        // Find the most common currency
                                                        let maxCount = 0;
                                                        for (const [currency, count] of Object.entries(currencyCounts)) {
                                                            if (count > maxCount) {
                                                                maxCount = count;
                                                                defaultCurrency = currency;
                                                            }
                                                        }
                                                    }
                                                    
                                                    document.getElementById('total-revenue').textContent = this.formatCurrency(totalRevenue, defaultCurrency);
                                                    
                                                    // Completion Rate
                                                    const completionRate = this.rides.length > 0
                                                        ? Math.round((completedRides.length / this.rides.length) * 100)
                                                        : 0;
                                                    document.getElementById('completion-rate').textContent = `${completionRate}%`;
                                                    
                                                    // Payment Statistics
                                                    const totalPayments = this.ridePayments ? this.ridePayments.length : 0;
                                                    const pendingPayments = this.ridePayments ? this.ridePayments.filter(p =>
                                                        (p.status === 'pending' || p.status === 'cancelled' || p.tapStatus === 'CANCELLED') && !p.paidAt
                                                    ).length : 0;
                                                    
                                                    const failedPayments = this.ridePayments ? this.ridePayments.filter(p =>
                                                        p.status === 'failed' || (p.tapStatus && p.tapStatus !== 'CAPTURED' && p.tapStatus !== 'CANCELLED')
                                                    ).length : 0;
                                                    
                                                    const paymentSuccessRate = totalPayments > 0
                                                        ? Math.round((successfulPayments.length / totalPayments) * 100)
                                                        : 0;

                                                    console.log('Dashboard stats updated:', {
                                                        totalRides: this.rides.length,
                                                        activeDrivers: activeDrivers.length,
                                                        totalRevenue: totalRevenue,
                                                        defaultCurrency: defaultCurrency,
                                                        completionRate: completionRate,
                                                        totalPayments: totalPayments,
                                                        successfulPayments: successfulPayments.length,
                                                        pendingPayments: pendingPayments,
                                                        failedPayments: failedPayments,
                                                        paymentSuccessRate: paymentSuccessRate
                                                    });
                                                    
                                                    // Update payment stats in UI if elements exist
                                                    if (document.getElementById('total-payments')) {
                                                        document.getElementById('total-payments').textContent = totalPayments;
                                                        document.getElementById('successful-payments').textContent = successfulPayments.length;
                                                        document.getElementById('pending-payments').textContent = pendingPayments;
                                                        document.getElementById('payment-success-rate').textContent = `${paymentSuccessRate}%`;
                                                    }

                                                    // Calculate total revenue from all successful payments
                                                    if (document.getElementById('total-revenue-detailed')) {
                                                        document.getElementById('total-revenue-detailed').textContent = this.formatCurrency(totalRevenue, defaultCurrency);
                                                    }

                                                    // Update payments count in sidebar
                                                    document.getElementById('payments-count').textContent = totalPayments;

                                                    // Initialize payment chart if we have payments
                                                    if (totalPayments > 0 && typeof Chart !== 'undefined' && document.getElementById('paymentChart')) {
                                                        setTimeout(() => this.initPaymentChart(), 100);
                                                    }
                                                }

                                                renderRecentRides() {
                                                    const container = document.getElementById('recent-rides-table');
                                                    const recentRides = this.rides.slice(0, 5);
                                                    
                                                    container.innerHTML = recentRides.map(ride => {
                                                        // Determine payment status badge
                                                        let paymentBadge = '';
                                                        let paymentStatus = 'No Payment';
                                                        let paymentColor = 'gray';
                                                        
                                                        if (ride.paymentData) {
                                                            if (ride.paymentStatus === 'paid' || ride.paymentStatus === 'CAPTURED') {
                                                                paymentStatus = 'Paid';
                                                                paymentColor = 'green';
                                                            } else if (ride.paymentStatus === 'cancelled' || ride.paymentStatus === 'CANCELLED') {
                                                                paymentStatus = 'Cancelled';
                                                                paymentColor = 'gray';
                                                            } else if (ride.paymentStatus === 'pending') {
                                                                paymentStatus = 'Pending';
                                                                paymentColor = 'yellow';
                                                            } else if (ride.paymentStatus === 'failed') {
                                                                paymentStatus = 'Failed';
                                                                paymentColor = 'red';
                                                            }
                                                            
                                                            paymentBadge = `<span class="bg-${paymentColor}-100 text-${paymentColor}-800 text-xs px-2 py-1 rounded-full ml-2">${paymentStatus}</span>`;
                                                        } else {
                                                            paymentBadge = '<span class="bg-gray-100 text-gray-800 text-xs px-2 py-1 rounded-full ml-2">No Payment</span>';
                                                        }
                                                        
                                                        // Get currency for display
                                                        const currency = ride.paymentData?.currency || 'USD';
                                                        const finalFareDisplay = this.formatCurrency(ride.finalFare || 0, currency);
                                                        const paymentAmountDisplay = ride.paymentAmount ?
                                                            this.formatCurrency(ride.paymentAmount, currency) : '-';
                                                        
                                                        return `
                                                            <tr class="border-b hover:bg-gray-50">
                                                                <td class="py-3">
                                                                    <div class="flex flex-col">
                                                                        <span class="text-sm font-mono">${ride.id.substring(0, 8)}...</span>
                                                                        <div class="mt-1">
                                                                            <span class="status-badge status-${ride.status} text-xs">
                                                                                ${this.getStatusText(ride.status)}
                                                                            </span>
                                                                            ${paymentBadge}
                                                                        </div>
                                                                    </div>
                                                                </td>
                                                                <td class="py-3">
                                                                    <div class="flex flex-col">
                                                                        <span class="font-medium">${finalFareDisplay}</span>
                                                                        <span class="text-xs text-gray-500">
                                                                            ${ride.paymentMethod ? ride.paymentMethod.toUpperCase() : 'N/A'}
                                                                        </span>
                                                                    </div>
                                                                </td>
                                                                <td class="py-3">
                                                                    <div class="text-sm">
                                                                        <div class="text-gray-500">${paymentAmountDisplay}</div>
                                                                    </div>
                                                                </td>
                                                                <td class="py-3 text-gray-500 text-sm">
                                                                    ${this.formatTime(ride.createdAt)}
                                                                </td>
                                                            </tr>
                                                        `;
                                                    }).join('');
                                                }

                                                renderRidesTable() {
                                                    const container = document.getElementById('rides-table');
                                                    const startIndex = (this.currentPage - 1) * this.pageSize;
                                                    const endIndex = startIndex + this.pageSize;
                                                    const filteredRides = this.filterRides();
                                                    const paginatedRides = filteredRides.slice(startIndex, endIndex);
                                                    
                                                    container.innerHTML = paginatedRides.map(ride => {
                                                        // Determine payment status
                                                        let paymentStatus = 'No Payment';
                                                        let paymentColor = 'gray';
                                                        let paymentIcon = 'fa-times-circle';
                                                        
                                                        if (ride.paymentData) {
                                                            if (ride.paymentStatus === 'paid' || ride.paymentStatus === 'CAPTURED') {
                                                                paymentStatus = 'Paid';
                                                                paymentColor = 'green';
                                                                paymentIcon = 'fa-check-circle';
                                                            } else if (ride.paymentStatus === 'cancelled' || ride.paymentStatus === 'CANCELLED') {
                                                                paymentStatus = 'Cancelled';
                                                                paymentColor = 'gray';
                                                                paymentIcon = 'fa-ban';
                                                            } else if (ride.paymentStatus === 'pending') {
                                                                paymentStatus = 'Pending';
                                                                paymentColor = 'yellow';
                                                                paymentIcon = 'fa-clock';
                                                            } else if (ride.paymentStatus === 'failed') {
                                                                paymentStatus = 'Failed';
                                                                paymentColor = 'red';
                                                                paymentIcon = 'fa-exclamation-circle';
                                                            }
                                                        }
                                                        
                                                        // Determine payment method
                                                        const paymentMethod = ride.paymentMethod || 'N/A';
                                                        const paymentMethodColor = paymentMethod === 'cash' ? 'blue' : 'purple';
                                                        
                                                        // Get currency for display
                                                        const currency = ride.paymentData?.currency || 'USD';
                                                        const finalFareDisplay = this.formatCurrency(ride.finalFare || 0, currency);
                                                        const paymentAmountDisplay = ride.paymentAmount ?
                                                            this.formatCurrency(ride.paymentAmount, currency) : this.formatCurrency(0, currency);
                                                        
                                                        return `
                                                            <tr class="border-b hover:bg-gray-50">
                                                                <td class="py-3">
                                                                    <div class="flex flex-col">
                                                                        <span class="text-sm font-mono">${ride.id.substring(0, 8)}...</span>
                                                                        <div class="text-xs text-gray-500">
                                                                            ${this.formatDate(ride.createdAt)}
                                                                        </div>
                                                                    </div>
                                                                </td>
                                                                <td class="py-3">
                                                                    <div class="flex flex-col">
                                                                        <span class="text-sm">${ride.riderId ? ride.riderId.substring(0, 8) + '...' : 'N/A'}</span>
                                                                        <div class="text-xs text-gray-500">
                                                                            <i class="fas fa-user mr-1"></i>Passenger
                                                                        </div>
                                                                    </div>
                                                                </td>
                                                                <td class="py-3">
                                                                    <div class="flex flex-col">
                                                                        <span class="text-sm">${ride.driverId ? ride.driverId.substring(0, 8) + '...' : 'N/A'}</span>
                                                                        <div class="text-xs text-gray-500">
                                                                            <i class="fas fa-car mr-1"></i>Driver
                                                                        </div>
                                                                    </div>
                                                                </td>
                                                                <td class="py-3">
                                                                    <div class="space-y-2">
                                                                        <!-- Trip Status -->
                                                                        <div>
                                                                            <span class="status-badge status-${ride.status} inline-flex items-center">
                                                                                <i class="fas fa-route mr-1 text-xs"></i>
                                                                                ${this.getStatusText(ride.status)}
                                                                            </span>
                                                                        </div>
                                                                        
                                                                        <!-- Payment Status -->
                                                                        <div>
                                                                            <span class="bg-${paymentColor}-100 text-${paymentColor}-800 text-xs px-2 py-1 rounded-full inline-flex items-center">
                                                                                <i class="fas ${paymentIcon} mr-1 text-xs"></i>
                                                                                ${paymentStatus}
                                                                            </span>
                                                                        </div>
                                                                        
                                                                        <!-- Payment Method -->
                                                                        <div>
                                                                            <span class="bg-${paymentMethodColor}-100 text-${paymentMethodColor}-800 text-xs px-2 py-1 rounded-full inline-flex items-center">
                                                                                <i class="fas ${paymentMethod === 'cash' ? 'fa-money-bill' : 'fa-credit-card'} mr-1 text-xs"></i>
                                                                                ${paymentMethod.toUpperCase()}
                                                                            </span>
                                                                        </div>
                                                                    </div>
                                                                </td>
                                                                <td class="py-3">
                                                                    <div class="space-y-1">
                                                                        <div class="font-medium">${finalFareDisplay}</div>
                                                                        <div class="text-xs text-gray-500">
                                                                            Paid: ${paymentAmountDisplay}
                                                                        </div>
                                                                    </div>
                                                                </td>
                                                                <td class="py-3">
                                                                    ${ride.distance ? (ride.distance / 1000).toFixed(1) + ' km' : 'N/A'}
                                                                </td>
                                                                <td class="py-3">
                                                                    <div class="flex space-x-2">
                                                                        <button onclick="dashboard.viewRideDetails('${ride.id}')" 
                                                                                class="text-blue-500 hover:text-blue-700" title="View Ride Details">
                                                                            <i class="fas fa-eye"></i>
                                                                        </button>
                                                                        ${ride.paymentData ? `
                                                                            <button onclick="dashboard.viewPaymentById('${ride.paymentId}')"
                                                                                    class="text-purple-500 hover:text-purple-700" title="View Payment Details">
                                                                                <i class="fas fa-receipt"></i>
                                                                            </button>
                                                                        ` : ''}
                                                                        ${ride.status === 'completed' && ride.paymentData && 
                                                                         (ride.paymentStatus === 'paid' || ride.paymentStatus === 'CAPTURED') ? `
                                                                            <button onclick="dashboard.refundRide('${ride.id}')"
                                                                                    class="text-green-500 hover:text-green-700" title="Refund">
                                                                                <i class="fas fa-redo"></i>
                                                                            </button>
                                                                        ` : ''}
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                        `;
                                                    }).join('');
                                                    
                                                    document.getElementById('rides-info').textContent =
                                                        `Showing ${startIndex + 1}-${Math.min(endIndex, filteredRides.length)} of ${filteredRides.length} rides`;
                                                    document.getElementById('current-page').textContent = this.currentPage;
                                                }
                                                
                                                renderPaymentsTable() {
                                                    const container = document.getElementById('payments-table');
                                                    if (!container) return;
                                                    
                                                    const statusFilter = document.getElementById('payment-status-filter')?.value || '';
                                                    const dateFilter = document.getElementById('payment-date-filter')?.value || '';
                                                    
                                                    // Filter payments
                                                    const filteredPayments = this.ridePayments.filter(payment => {
                                                        // Status filter
                                                        let matchesStatus = true;
                                                        if (statusFilter) {
                                                            switch(statusFilter) {
                                                                case 'paid':
                                                                    matchesStatus = payment.status === 'paid' || payment.tapStatus === 'CAPTURED';
                                                                    break;
                                                                case 'pending':
                                                                    matchesStatus = (payment.status === 'pending' || !payment.paidAt) &&
                                                                                   payment.tapStatus !== 'CANCELLED';
                                                                    break;
                                                                case 'cancelled':
                                                                    matchesStatus = payment.status === 'cancelled' || payment.tapStatus === 'CANCELLED';
                                                                    break;
                                                                case 'failed':
                                                                    matchesStatus = payment.status === 'failed' ||
                                                                                   (payment.tapStatus && payment.tapStatus !== 'CAPTURED' &&
                                                                                    payment.tapStatus !== 'CANCELLED' && payment.tapStatus !== 'PENDING');
                                                                    break;
                                                            }
                                                        }
                                                        
                                                        // Date filter
                                                        let matchesDate = true;
                                                        if (dateFilter && payment.createdAt) {
                                                            matchesDate = this.formatDate(payment.createdAt) === dateFilter;
                                                        }
                                                        
                                                        return matchesStatus && matchesDate;
                                                    });
                                                    
                                                    // Update payment summary stats
                                                    const totalPayments = this.ridePayments.length;
                                                    const successfulPayments = this.ridePayments.filter(p =>
                                                        p.status === 'paid' || p.tapStatus === 'CAPTURED'
                                                    ).length;
                                                    const pendingPayments = this.ridePayments.filter(p =>
                                                        (p.status === 'pending' || (!p.paidAt && p.tapStatus !== 'CANCELLED'))
                                                    ).length;
                                                    const failedPayments = this.ridePayments.filter(p =>
                                                        p.status === 'cancelled' || p.status === 'failed' || p.tapStatus === 'CANCELLED' ||
                                                        (p.tapStatus && p.tapStatus !== 'CAPTURED' && p.tapStatus !== 'CANCELLED' && p.tapStatus !== 'PENDING')
                                                    ).length;
                                                    
                                                    // Update summary cards
                                                    document.getElementById('payments-total').textContent = totalPayments;
                                                    document.getElementById('payments-successful').textContent = successfulPayments;
                                                    document.getElementById('payments-pending').textContent = pendingPayments;
                                                    document.getElementById('payments-failed').textContent = failedPayments;
                                                    
                                                    // Get recent payments (last 10)
                                                    const recentPayments = filteredPayments.slice(0, 10);
                                                    
                                                    container.innerHTML = recentPayments.map(payment => {
                                                        // Determine status color and text
                                                        let statusColor = 'gray';
                                                        let statusText = payment.status || payment.tapStatus || 'pending';
                                                        
                                                        if (payment.status === 'paid' || payment.tapStatus === 'CAPTURED') {
                                                            statusColor = 'green';
                                                            statusText = 'Paid';
                                                        } else if (payment.status === 'cancelled' || payment.tapStatus === 'CANCELLED') {
                                                            statusColor = 'gray';
                                                            statusText = 'Cancelled';
                                                        } else if (payment.status === 'failed') {
                                                            statusColor = 'red';
                                                            statusText = 'Failed';
                                                        } else if (payment.status === 'pending') {
                                                            statusColor = 'yellow';
                                                            statusText = 'Pending';
                                                        }
                                                        
                                                        // Find passenger name
                                                        const passenger = this.passengers.find(p => p.id === payment.userId);
                                                        const passengerName = passenger ? passenger.full_name : payment.userId.substring(0, 8) + '...';
                                                        
                                                        // Format amount with correct currency
                                                        const amountDisplay = this.formatCurrency(
                                                            payment.baseAmount || payment.lockedAmount || 0,
                                                            payment.currency || 'USD'
                                                        );
                                                        
                                                        return `
                                                            <tr class="border-b hover:bg-gray-50">
                                                                <td class="py-3 text-sm font-mono" title="${payment.id}">
                                                                    ${payment.id.substring(0, 8)}...
                                                                </td>
                                                                <td class="py-3">
                                                                    <div class="flex items-center">
                                                                        <div class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center mr-2">
                                                                            <i class="fas fa-user text-gray-500 text-sm"></i>
                                                                        </div>
                                                                        <div>
                                                                            <p class="font-medium text-sm">${passengerName}</p>
                                                                            <p class="text-xs text-gray-500">${payment.userId.substring(0, 8)}...</p>
                                                                        </div>
                                                                    </div>
                                                                </td>
                                                                <td class="py-3">
                                                                    <p class="font-bold">${amountDisplay}</p>
                                                                    <p class="text-xs text-gray-500">${payment.purpose || 'N/A'}</p>
                                                                </td>
                                                                <td class="py-3">
                                                                    <span class="px-2 py-1 rounded-full text-xs bg-${statusColor}-100 text-${statusColor}-800">
                                                                        ${statusText}
                                                                    </span>
                                                                </td>
                                                                <td class="py-3">
                                                                    <span class="px-2 py-1 rounded text-xs ${payment.paymentProvider === 'tap' ? 'bg-purple-100 text-purple-800' : 'bg-blue-100 text-blue-800'}">
                                                                        ${payment.paymentProvider || 'N/A'}
                                                                    </span>
                                                                </td>
                                                                <td class="py-3 text-sm text-gray-500">
                                                                    ${this.formatDate(payment.createdAt)}<br>
                                                                    <span class="text-xs">${this.formatTime(payment.createdAt)}</span>
                                                                </td>
                                                                <td class="py-3">
                                                                    <button onclick="dashboard.viewPaymentById('${payment.id}')" 
                                                                            class="text-blue-500 hover:text-blue-700 mr-2" title="View Details">
                                                                        <i class="fas fa-eye"></i>
                                                                    </button>
                                                                    ${payment.tapTransactionUrl ? `
                                                                        <a href="${payment.tapTransactionUrl}" target="_blank"
                                                                           class="text-purple-500 hover:text-purple-700 mr-2" title="View on Tap">
                                                                            <i class="fas fa-external-link-alt"></i>
                                                                        </a>
                                                                    ` : ''}
                                                                </td>
                                                            </tr>
                                                        `;
                                                    }).join('');
                                                    
                                                    // Show message if no payments
                                                    if (recentPayments.length === 0) {
                                                        container.innerHTML = `
                                                            <tr>
                                                                <td colspan="7" class="py-8 text-center text-gray-500">
                                                                    <i class="fas fa-credit-card text-4xl mb-2 text-gray-300"></i>
                                                                    <p>No payments found matching your filters</p>
                                                                </td>
                                                            </tr>
                                                        `;
                                                    }
                                                }

                                                    // Add new method to view payment details
                                                    async viewPaymentDetails(rideId) {
                                                        const ride = this.rides.find(r => r.id === rideId);
                                                        if (!ride || !ride.paymentData) {
                                                            this.showNotification('No payment data found for this ride', 'error');
                                                            return;
                                                        }

                                                        const payment = ride.paymentData;
                                                        const content = document.getElementById('ride-details-content');
                                                        
                                                        content.innerHTML = `
                                                            <div class="space-y-6">
                                                                <div class="flex justify-between items-center mb-6">
                                                                    <h4 class="text-xl font-semibold">Payment Details</h4>
                                                                    <span class="px-3 py-1 rounded-full ${payment.status === 'paid' || payment.tapStatus === 'CAPTURED' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                                                        ${payment.status === 'paid' || payment.tapStatus === 'CAPTURED' ? 'Paid' : 'Pending'}
                                                                    </span>
                                                                </div>
                                                                
                                                                <div class="grid grid-cols-2 gap-4">
                                                                    <div>
                                                                        <label class="text-sm text-gray-500">Payment ID</label>
                                                                        <p class="font-mono">${payment.id}</p>
                                                                    </div>
                                                                    <div>
                                                                        <label class="text-sm text-gray-500">Ride ID</label>
                                                                        <p class="font-mono">${ride.id}</p>
                                                                    </div>
                                                                </div>
                                                                
                                                                <div class="grid grid-cols-2 gap-4">
                                                                    <div>
                                                                        <label class="text-sm text-gray-500">User ID</label>
                                                                        <p class="font-mono">${payment.userId || ride.riderId}</p>
                                                                    </div>
                                                                    <div>
                                                                        <label class="text-sm text-gray-500">Payment Provider</label>
                                                                        <p class="font-medium">${payment.paymentProvider || 'N/A'}</p>
                                                                    </div>
                                                                </div>
                                                                
                                                                <div class="border-t pt-4">
                                                                    <h4 class="font-medium mb-4">Amount Details</h4>
                                                                    <div class="grid grid-cols-2 gap-4">
                                                                        <div>
                                                                            <label class="text-sm text-gray-500">Base Amount</label>
                                                                            <p class="text-xl font-bold">$${(payment.baseAmount || 0).toFixed(2)}</p>
                                                                        </div>
                                                                        <div>
                                                                            <label class="text-sm text-gray-500">Locked Amount</label>
                                                                            <p class="text-xl font-bold">$${(payment.lockedAmount || 0).toFixed(2)}</p>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                
                                                                <div class="border-t pt-4">
                                                                    <h4 class="font-medium mb-4">Transaction Information</h4>
                                                                    <div class="space-y-3">
                                                                        <div>
                                                                            <label class="text-sm text-gray-500">Tap Charge ID</label>
                                                                            <p class="font-mono">${payment.tapChargeId || 'N/A'}</p>
                                                                        </div>
                                                                        <div>
                                                                            <label class="text-sm text-gray-500">Tap Status</label>
                                                                            <p class="font-medium">${payment.tapStatus || 'N/A'}</p>
                                                                        </div>
                                                                        <div>
                                                                            <label class="text-sm text-gray-500">Currency</label>
                                                                            <p class="font-medium">${payment.currency || 'N/A'}</p>
                                                                        </div>
                                                                        <div>
                                                                            <label class="text-sm text-gray-500">Purpose</label>
                                                                            <p class="font-medium">${payment.purpose || 'N/A'}</p>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                
                                                                <div class="border-t pt-4">
                                                                    <h4 class="font-medium mb-4">Location Information</h4>
                                                                    <div class="grid grid-cols-2 gap-4">
                                                                        <div>
                                                                            <label class="text-sm text-gray-500">City</label>
                                                                            <p class="font-medium">${payment.cityId || 'N/A'}</p>
                                                                        </div>
                                                                        <div>
                                                                            <label class="text-sm text-gray-500">Country Code</label>
                                                                            <p class="font-medium">${payment.countryCode || 'N/A'}</p>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                
                                                                <div class="border-t pt-4">
                                                                    <h4 class="font-medium mb-4">Timestamps</h4>
                                                                    <div class="space-y-1 text-sm">
                                                                        <p>Created: ${this.formatDateTime(payment.createdAt)}</p>
                                                                        <p>Paid: ${payment.paidAt ? this.formatDateTime(payment.paidAt) : 'Not paid yet'}</p>
                                                                        <p>Last Updated: ${this.formatDateTime(payment.updatedAt)}</p>
                                                                    </div>
                                                                </div>
                                                                
                                                                ${payment.tapTransactionUrl ? `
                                                                    <div class="border-t pt-4">
                                                                        <a href="${payment.tapTransactionUrl}" target="_blank"
                                                                           class="inline-flex items-center px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                                                                            <i class="fas fa-external-link-alt mr-2"></i>
                                                                            View Transaction on Tap
                                                                        </a>
                                                                    </div>
                                                                ` : ''}
                                                            </div>
                                                        `;
                                                        
                                                        document.querySelector('#ride-modal h3').textContent = 'Payment Details';
                                                        document.getElementById('ride-modal').classList.remove('hidden');
                                                    }
                                                       
                                                       renderPassengersTable() {
                                                           const container = document.getElementById('passengers-table');
                                                           const searchTerm = document.getElementById('passenger-search')?.value.toLowerCase() || '';
                                                           
                                                           const filteredPassengers = this.passengers.filter(passenger => {
                                                               const fullName = passenger.full_name.toLowerCase();
                                                               const email = passenger.email.toLowerCase();
                                                               const phone = passenger.phone.toLowerCase();
                                                               
                                                               return fullName.includes(searchTerm) ||
                                                                      email.includes(searchTerm) ||
                                                                      phone.includes(searchTerm);
                                                           });
                                                           
                                                           container.innerHTML = filteredPassengers.map(passenger => `
                                                               <tr class="border-b hover:bg-gray-50">
                                                                   <td class="py-3">
                                                                       <div class="flex items-center">
                                                                           <img src="${passenger.avatar || 'https://via.placeholder.com/32'}" 
                                                                                alt="${passenger.full_name}" 
                                                                                class="w-10 h-10 rounded-full mr-3">
                                                                           <div>
                                                                               <p class="font-medium">${passenger.full_name || 'Unknown Passenger'}</p>
                                                                               <p class="text-sm text-gray-500">ID: ${passenger.id.substring(0, 8)}...</p>
                                                                           </div>
                                                                       </div>
                                                                   </td>
                                                                   <td class="py-3">${passenger.email || 'N/A'}</td>
                                                                   <td class="py-3">${passenger.phone || 'N/A'}</td>
                                                                   <td class="py-3">
                                                                       <span class="status-badge ${passenger.is_active_combined ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                                                           ${passenger.is_active_combined ? 'Active' : 'Inactive'}
                                                                       </span>
                                                                   </td>
                                                                   <td class="py-3">
                                                                       ${this.getPassengerRideCount(passenger.id)}
                                                                   </td>
                                                                   <td class="py-3 text-sm text-gray-500">
                                                                       ${this.formatDate(passenger.user_created_at || passenger.passenger_created_at)}
                                                                   </td>
                                                                   <td class="py-3">
                                                                       <button onclick="dashboard.viewPassengerDetails('${passenger.id}')" 
                                                                               class="text-blue-500 hover:text-blue-700 mr-3">
                                                                           <i class="fas fa-eye"></i>
                                                                       </button>
                                                                       <button onclick="dashboard.togglePassengerStatus('${passenger.id}', ${passenger.is_active_combined})" 
                                                                               class="${passenger.is_active_combined ? 'text-red-500 hover:text-red-700' : 'text-green-500 hover:text-green-700'}">
                                                                           <i class="fas fa-power-off"></i>
                                                                       </button>
                                                                   </td>
                                                               </tr>
                                                           `).join('');
                                                       }


                                                       getPassengerRideCount(passengerId) {
                                                               const rideCount = this.rides.filter(ride => ride.riderId === passengerId).length;
                                                               return `<span class="bg-gray-100 text-gray-800 px-2 py-1 rounded-full text-sm">${rideCount} rides</span>`;
                                                           }
                                                       renderDriversTable() {
                                                               const container = document.getElementById('drivers-table');
                                                               const searchTerm = document.getElementById('driver-search')?.value.toLowerCase() || '';
                                                               const statusFilter = document.getElementById('driver-status-filter')?.value || '';
                                                               
                                                               const filteredDrivers = this.drivers.filter(driver => {
                                                                   // Search filter
                                                                   const fullName = driver.full_name.toLowerCase();
                                                                   const email = (driver.display_email || driver.email || '').toLowerCase();
                                                                   const city = driver.city?.toLowerCase() || '';
                                                                   const vehicle = `${driver.selected_vehicle || ''} ${driver.selected_model || ''}`.toLowerCase();
                                                                   
                                                                   const matchesSearch = fullName.includes(searchTerm) ||
                                                                          email.includes(searchTerm) ||
                                                                          city.includes(searchTerm) ||
                                                                          vehicle.includes(searchTerm) ||
                                                                          driver.id.toLowerCase().includes(searchTerm);
                                                                   
                                                                   // Status filter
                                                                   let matchesStatus = true;
                                                                   if (statusFilter) {
                                                                       switch(statusFilter) {
                                                                           case 'active':
                                                                               matchesStatus = driver.is_active_combined === true;
                                                                               break;
                                                                           case 'inactive':
                                                                               matchesStatus = driver.is_active_combined === false;
                                                                               break;
                                                                           case 'verified':
                                                                               matchesStatus = driver.is_registeration_completed === true;
                                                                               break;
                                                                           case 'pending':
                                                                               matchesStatus = driver.is_registeration_completed === false;
                                                                               break;
                                                                       }
                                                                   }
                                                                   
                                                                   return matchesSearch && matchesStatus;
                                                               });
                                                               
                                                               container.innerHTML = filteredDrivers.map(driver => `
                                                                   <tr class="border-b hover:bg-gray-50">
                                                                       <td class="py-3 text-sm font-mono">${driver.id.substring(0, 10)}...</td>
                                                                       <td class="py-3">
                                                                           <div class="flex items-center">
                                                                               <img src="${driver.profile_picture_url || 'https://via.placeholder.com/32'}" 
                                                                                    alt="${driver.full_name}" 
                                                                                    class="w-10 h-10 rounded-full mr-3">
                                                                               <div>
                                                                                   <p class="font-medium">${driver.full_name || 'Unknown Driver'}</p>
                                                                                   <p class="text-xs text-gray-500">${driver.display_email || driver.email || 'No email'}</p>
                                                                               </div>
                                                                           </div>
                                                                       </td>
                                                                       <td class="py-3">
                                                                           <div class="flex flex-col">
                                                                               <span class="font-medium">${driver.selected_vehicle || 'N/A'} ${driver.selected_model || ''}</span>
                                                                               <span class="text-xs text-gray-500">${driver.licence_plate || 'No plate'}</span>
                                                                           </div>
                                                                       </td>
                                                                       <td class="py-3">
                                                                           <div class="flex flex-col">
                                                                               <span>${driver.city || 'N/A'}, ${driver.country || 'N/A'}</span>
                                                                               <span class="text-xs text-gray-500">${driver.billing_type || 'N/A'}</span>
                                                                           </div>
                                                                       </td>
                                                                       <td class="py-3">
                                                                           <div class="flex items-center">
                                                                               <i class="fas fa-star text-yellow-400 mr-1 text-sm"></i>
                                                                               <span>${driver.rating || 'N/A'}</span>
                                                                           </div>
                                                                       </td>
                                                                       <td class="py-3">
                                                                           <span class="status-badge ${driver.is_active_combined ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                                                               ${driver.is_active_combined ? 'Active' : 'Inactive'}
                                                                           </span>
                                                                           ${driver.is_registeration_completed ? 
                                                                               '<span class="ml-1 status-badge bg-blue-100 text-blue-800">Verified</span>' : 
                                                                               '<span class="ml-1 status-badge bg-yellow-100 text-yellow-800">Pending</span>'
                                                                           }
                                                                       </td>
                                                                       <td class="py-3">
                                                                           <button onclick="dashboard.viewDriverDetails('${driver.id}')" 
                                                                                   class="text-blue-500 hover:text-blue-700 mr-3" title="View Details">
                                                                               <i class="fas fa-eye"></i>
                                                                           </button>
                                                                           <button onclick="dashboard.toggleDriverStatus('${driver.id}', ${driver.is_active_combined})" 
                                                                                   class="${driver.is_active_combined ? 'text-red-500 hover:text-red-700' : 'text-green-500 hover:text-green-700'}" 
                                                                                   title="${driver.is_active_combined ? 'Deactivate' : 'Activate'}">
                                                                               <i class="fas fa-power-off"></i>
                                                                           </button>
                                                                       </td>
                                                                   </tr>
                                                               `).join('');
                                                           }

                                                       renderSupportedCountries() {
                                                               const container = document.getElementById('supported-countries');
                                                               if (this.appConfig?.supportedCountries) {
                                                                   container.innerHTML = this.appConfig.supportedCountries.map(country => `
                                                                       <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                                                           <span>${this.getCountryName(country)}</span>
                                                                           <span class="text-sm text-gray-500">${country}</span>
                                                                       </div>
                                                                   `).join('');
                                                               } else {
                                                                   container.innerHTML = '<p class="text-gray-500">No countries configured</p>';
                                                               }
                                                               
                                                               if (this.appConfig?.lastUpdated) {
                                                                   document.getElementById('last-updated').textContent =
                                                                       this.formatDate(this.appConfig.lastUpdated.toDate());
                                                               } else {
                                                                   document.getElementById('last-updated').textContent = 'Never';
                                                               }
                                                           }

                                                       filterRides() {
                                                               const statusFilter = document.getElementById('status-filter').value;
                                                               const dateFilter = document.getElementById('date-filter').value;
                                                               
                                                               return this.rides.filter(ride => {
                                                                   const matchesStatus = !statusFilter || ride.status === statusFilter;
                                                                   const matchesDate = !dateFilter ||
                                                                       this.formatDate(ride.createdAt) === dateFilter;
                                                                   return matchesStatus && matchesDate;
                                                               });
                                                           }

                                                       initCharts() {
                                                               const ctx = document.getElementById('rideStatusChart');
                                                               if (!ctx) return;
                                                               
                                                               // Destroy existing chart if it exists
                                                               if (this.rideChart) {
                                                                   this.rideChart.destroy();
                                                               }
                                                               
                                                               // Calculate status distribution
                                                               const statusCounts = {};
                                                               this.rides.forEach(ride => {
                                                                   statusCounts[ride.status] = (statusCounts[ride.status] || 0) + 1;
                                                               });

                                                               const statusLabels = {
                                                                   requested: 'Requested',
                                                                   accepted: 'Accepted',
                                                                   arrived: 'Arrived',
                                                                   inProgress: 'In Progress',
                                                                   completed: 'Completed',
                                                                   cancelledByPassenger: 'Cancelled (Passenger)',
                                                                   cancelledByDriver: 'Cancelled (Driver)',
                                                                   timeout: 'Timeout'
                                                               };

                                                               const data = Object.keys(statusCounts).map(key => statusCounts[key]);
                                                               const labels = Object.keys(statusCounts).map(key => statusLabels[key] || key);
                                                               const backgroundColors = [
                                                                   '#3b82f6', '#10b981', '#8b5cf6', '#f59e0b',
                                                                   '#ef4444', '#ec4899', '#6366f1', '#94a3b8'
                                                               ];

                                                               this.rideChart = new Chart(ctx.getContext('2d'), {
                                                                   type: 'doughnut',
                                                                   data: {
                                                                       labels: labels,
                                                                       datasets: [{
                                                                           data: data,
                                                                           backgroundColor: backgroundColors,
                                                                           borderWidth: 1
                                                                       }]
                                                                   },
                                                                   options: {
                                                                       responsive: true,
                                                                       maintainAspectRatio: false,
                                                                       plugins: {
                                                                           legend: {
                                                                               position: 'bottom',
                                                                               labels: {
                                                                                   padding: 20,
                                                                                   usePointStyle: true
                                                                               }
                                                                           }
                                                                       }
                                                                   }
                                                               });
                                                           }
            
            initPaymentChart() {
                const paymentCtx = document.getElementById('paymentChart');
                if (!paymentCtx || !this.ridePayments || this.ridePayments.length === 0) return;
                
                // Calculate payment statistics
                const paymentStats = {
                    total: this.ridePayments.length,
                    paid: this.ridePayments.filter(p => p.status === 'paid' || p.tapStatus === 'CAPTURED').length,
                    pending: this.ridePayments.filter(p =>
                        p.status === 'pending' || (!p.paidAt && p.status !== 'cancelled')
                    ).length,
                    cancelled: this.ridePayments.filter(p =>
                        p.status === 'cancelled' || p.tapStatus === 'CANCELLED'
                    ).length,
                    failed: this.ridePayments.filter(p =>
                        p.status === 'failed' || (p.tapStatus && p.tapStatus !== 'CAPTURED' && p.tapStatus !== 'CANCELLED' && p.tapStatus !== 'PENDING')
                    ).length
                };
                
                // Destroy existing chart if it exists
                if (this.paymentChart) {
                    this.paymentChart.destroy();
                }
                
                this.paymentChart = new Chart(paymentCtx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: ['Total', 'Paid', 'Pending', 'Cancelled', 'Failed'],
                        datasets: [{
                            label: 'Payment Status Count',
                            data: [paymentStats.total, paymentStats.paid, paymentStats.pending, paymentStats.cancelled, paymentStats.failed],
                            backgroundColor: [
                                'rgba(59, 130, 246, 0.7)',
                                'rgba(16, 185, 129, 0.7)',
                                'rgba(245, 158, 11, 0.7)',
                                'rgba(148, 163, 184, 0.7)',
                                'rgba(239, 68, 68, 0.7)'
                            ],
                            borderColor: [
                                'rgb(59, 130, 246)',
                                'rgb(16, 185, 129)',
                                'rgb(245, 158, 11)',
                                'rgb(148, 163, 184)',
                                'rgb(239, 68, 68)'
                            ],
                            borderWidth: 2,
                            borderRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: ${context.raw}`;
                                    }
                                }
                            },
                            title: {
                                display: true,
                                text: 'Payment Status Distribution',
                                font: {
                                    size: 16
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    precision: 0
                                },
                                title: {
                                    display: true,
                                    text: 'Number of Payments'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Payment Status'
                                }
                            }
                        }
                    }
                });
            }
            
            async viewAllPayments() {
                const content = document.getElementById('ride-details-content');
                
                // Sort payments by date (newest first)
                const sortedPayments = [...this.ridePayments].sort((a, b) =>
                    b.createdAt - a.createdAt
                );
                
                content.innerHTML = `
                    <div class="space-y-6">
                        <div class="flex justify-between items-center mb-6">
                            <h4 class="text-xl font-semibold">All Payments</h4>
                            <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full">
                                ${sortedPayments.length} payments
                            </span>
                        </div>
                        
                        <div class="overflow-y-auto max-h-[70vh]">
                            <table class="min-w-full">
                                <thead class="sticky top-0 bg-white">
                                    <tr class="border-b">
                                        <th class="text-left py-3 text-gray-600">Payment ID</th>
                                        <th class="text-left py-3 text-gray-600">User ID</th>
                                        <th class="text-left py-3 text-gray-600">Amount</th>
                                        <th class="text-left py-3 text-gray-600">Status</th>
                                        <th class="text-left py-3 text-gray-600">Provider</th>
                                        <th class="text-left py-3 text-gray-600">Date</th>
                                        <th class="text-left py-3 text-gray-600">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${sortedPayments.map(payment => {
                                        const statusColor = payment.status === 'paid' || payment.tapStatus === 'CAPTURED' ? 'green' :
                                                          payment.status === 'cancelled' || payment.tapStatus === 'CANCELLED' ? 'gray' :
                                                          payment.status === 'failed' ? 'red' : 'yellow';
                                        
                                        return `
                                            <tr class="border-b hover:bg-gray-50">
                                                <td class="py-3 text-sm font-mono" title="${payment.id}">
                                                    ${payment.id.substring(0, 10)}...
                                                </td>
                                                <td class="py-3 text-sm font-mono" title="${payment.userId}">
                                                    ${payment.userId.substring(0, 10)}...
                                                </td>
                                                <td class="py-3 font-medium">
                                                    ${this.formatCurrency(payment.baseAmount || payment.lockedAmount || 0, payment.currency || 'USD')}
                                                </td>
                                                <td class="py-3">
                                                    <span class="px-2 py-1 rounded-full text-xs bg-${statusColor}-100 text-${statusColor}-800">
                                                        ${payment.status || payment.tapStatus || 'pending'}
                                                    </span>
                                                </td>
                                                <td class="py-3">
                                                    ${payment.paymentProvider || 'N/A'}
                                                </td>
                                                <td class="py-3 text-sm text-gray-500">
                                                    ${this.formatDate(payment.createdAt)}
                                                </td>
                                                <td class="py-3">
                                                    <button onclick="dashboard.viewPaymentById('${payment.id}')"
                                                            class="text-blue-500 hover:text-blue-700 mr-2" title="View Details">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    ${payment.tapTransactionUrl ? `
                                                        <a href="${payment.tapTransactionUrl}" target="_blank"
                                                           class="text-purple-500 hover:text-purple-700" title="View on Tap">
                                                            <i class="fas fa-external-link-alt"></i>
                                                        </a>
                                                    ` : ''}
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="border-t pt-4">
                            <h4 class="font-medium mb-2">Payment Summary</h4>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div class="bg-blue-50 p-3 rounded-lg">
                                    <p class="text-sm text-blue-600">Total Payments</p>
                                    <p class="text-xl font-bold">${sortedPayments.length}</p>
                                </div>
                                <div class="bg-green-50 p-3 rounded-lg">
                                    <p class="text-sm text-green-600">Successful</p>
                                    <p class="text-xl font-bold">${sortedPayments.filter(p => p.status === 'paid' || p.tapStatus === 'CAPTURED').length}</p>
                                </div>
                                <div class="bg-yellow-50 p-3 rounded-lg">
                                    <p class="text-sm text-yellow-600">Pending</p>
                                    <p class="text-xl font-bold">${sortedPayments.filter(p => p.status === 'pending' && p.tapStatus !== 'CANCELLED').length}</p>
                                </div>
                                <div class="bg-red-50 p-3 rounded-lg">
                                    <p class="text-sm text-red-600">Cancelled/Failed</p>
                                    <p class="text-xl font-bold">${sortedPayments.filter(p => 
                                        p.status === 'cancelled' || p.status === 'failed' || p.tapStatus === 'CANCELLED'
                                    ).length}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.querySelector('#ride-modal h3').textContent = 'All Payments';
                document.getElementById('ride-modal').classList.remove('hidden');
            }
            
            async viewPaymentById(paymentId) {
                const payment = this.ridePayments.find(p => p.id === paymentId);
                if (!payment) {
                    this.showNotification('Payment not found', 'error');
                    return;
                }

                // Find associated ride if any
                const associatedRide = this.rides.find(ride =>
                    ride.paymentData?.id === paymentId ||
                    ride.tapChargeId === payment.tapChargeId ||
                    ride.paymentId === paymentId
                );

                const content = document.getElementById('ride-details-content');
                
                content.innerHTML = `
                    <div class="space-y-6">
                        <div class="flex justify-between items-center mb-6">
                            <h4 class="text-xl font-semibold">Payment Details</h4>
                            <span class="px-3 py-1 rounded-full ${
                                payment.status === 'paid' || payment.tapStatus === 'CAPTURED' ? 
                                'bg-green-100 text-green-800' : 
                                payment.status === 'cancelled' || payment.tapStatus === 'CANCELLED' ?
                                'bg-gray-100 text-gray-800' : 'bg-yellow-100 text-yellow-800'
                            }">
                                ${payment.status || payment.tapStatus || 'pending'}
                            </span>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm text-gray-500">Payment ID</label>
                                <p class="font-mono" title="${payment.id}">${payment.id}</p>
                            </div>
                            <div>
                                <label class="text-sm text-gray-500">Tap Charge ID</label>
                                <p class="font-mono" title="${payment.tapChargeId || 'N/A'}">${payment.tapChargeId || 'N/A'}</p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm text-gray-500">User ID</label>
                                <p class="font-mono" title="${payment.userId}">${payment.userId}</p>
                            </div>
                            <div>
                                <label class="text-sm text-gray-500">Payment Provider</label>
                                <p class="font-medium">${payment.paymentProvider || 'N/A'}</p>
                            </div>
                        </div>
                        
                        <!-- Amount Details -->
                        <div class="border-t pt-4">
                            <h4 class="font-medium mb-4">Amount Details</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-sm text-gray-500">Base Amount</label>
                                    <p class="text-2xl font-bold">${this.formatCurrency(payment.baseAmount || 0, payment.currency || 'USD')}</p>
                                </div>
                                <div>
                                    <label class="text-sm text-gray-500">Locked Amount</label>
                                    <p class="text-2xl font-bold">${this.formatCurrency(payment.lockedAmount || 0, payment.currency || 'USD')}</p>
                                </div>
                                <div>
                                    <label class="text-sm text-gray-500">Currency</label>
                                    <p class="font-medium">${payment.currency || 'N/A'} (${this.getCurrencyName(payment.currency)})</p>
                                </div>
                                <div>
                                    <label class="text-sm text-gray-500">Purpose</label>
                                    <p class="font-medium">${payment.purpose || 'N/A'}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="border-t pt-4">
                            <h4 class="font-medium mb-4">Location Information</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-sm text-gray-500">City</label>
                                    <p class="font-medium">${payment.cityId || 'N/A'}</p>
                                </div>
                                <div>
                                    <label class="text-sm text-gray-500">Country Code</label>
                                    <p class="font-medium">${payment.countryCode || 'N/A'}</p>
                                </div>
                            </div>
                        </div>
                        
                        ${payment.ridePreview ? `
                            <div class="border-t pt-4">
                                <h4 class="font-medium mb-4">Ride Preview</h4>
                                <div class="space-y-3">
                                    <div>
                                        <label class="text-sm text-gray-500">Pickup Location</label>
                                        <p>${payment.ridePreview.pickup?.name || 'N/A'}</p>
                                        <p class="text-xs text-gray-500">
                                            Lat: ${payment.ridePreview.pickup?.lat},
                                            Lng: ${payment.ridePreview.pickup?.lng}
                                        </p>
                                    </div>
                                    <div>
                                        <label class="text-sm text-gray-500">Destination</label>
                                        <p>${payment.ridePreview.destination?.name || 'N/A'}</p>
                                        <p class="text-xs text-gray-500">
                                            Lat: ${payment.ridePreview.destination?.lat},
                                            Lng: ${payment.ridePreview.destination?.lng}
                                        </p>
                                    </div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="text-sm text-gray-500">Distance</label>
                                            <p>${payment.ridePreview.distance ? `${payment.ridePreview.distance} km` : 'N/A'}</p>
                                        </div>
                                        <div>
                                            <label class="text-sm text-gray-500">Duration</label>
                                            <p>${payment.ridePreview.duration ? `${Math.round(payment.ridePreview.duration)} min` : 'N/A'}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="border-t pt-4">
                            <h4 class="font-medium mb-4">Timestamps</h4>
                            <div class="space-y-1 text-sm">
                                <p>Created: ${this.formatDateTime(payment.createdAt)}</p>
                                <p>Paid: ${payment.paidAt ? this.formatDateTime(payment.paidAt) : 'Not paid yet'}</p>
                                <p>Last Updated: ${this.formatDateTime(payment.updatedAt)}</p>
                            </div>
                        </div>
                        
                        ${associatedRide ? `
                            <div class="border-t pt-4">
                                <h4 class="font-medium mb-4">Associated Ride</h4>
                                <div class="flex justify-between items-center">
                                    <div>
                                        <p class="font-medium">Ride ID: ${associatedRide.id}</p>
                                        <p class="text-sm text-gray-500">Status: ${this.getStatusText(associatedRide.status)}</p>
                                    </div>
                                    <button onclick="dashboard.viewRideDetails('${associatedRide.id}')"
                                            class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                                        View Ride Details
                                    </button>
                                </div>
                            </div>
                        ` : ''}
                        
                        ${payment.tapTransactionUrl ? `
                            <div class="border-t pt-4">
                                <a href="${payment.tapTransactionUrl}" target="_blank"
                                   class="inline-flex items-center px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                                    <i class="fas fa-external-link-alt mr-2"></i>
                                    View Transaction on Tap
                                </a>
                            </div>
                        ` : ''}
                    </div>
                `;
                
                document.querySelector('#ride-modal h3').textContent = 'Payment Details';
                document.getElementById('ride-modal').classList.remove('hidden');
            }
            
            
            async viewPassengerDetails(passengerId) {
                    const passenger = this.passengers.find(p => p.id === passengerId);
                    if (!passenger) {
                        this.showNotification('Passenger not found', 'error');
                        return;
                    }

                    // Get passenger's rides
                    const passengerRides = this.rides.filter(ride => ride.riderId === passengerId);
                    
                    const content = document.getElementById('ride-details-content');
                    content.innerHTML = `
                        <div class="space-y-4">
                            <div class="flex items-center space-x-4">
                                <img src="${passenger.avatar || 'https://via.placeholder.com/100'}" 
                                     alt="${passenger.full_name}" 
                                     class="w-20 h-20 rounded-full">
                                <div>
                                    <h4 class="text-xl font-semibold">${passenger.full_name || 'Unknown Passenger'}</h4>
                                    <p class="text-gray-500">${passenger.email}</p>
                                    <p class="text-sm">ID: ${passenger.id}</p>
                                    <p class="text-sm text-gray-500">Role: ${passenger.role}</p>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-sm text-gray-500">Phone Number</label>
                                    <p class="font-medium">${passenger.phone || 'N/A'}</p>
                                </div>
                                <div>
                                    <label class="text-sm text-gray-500">Status</label>
                                    <p><span class="status-badge ${passenger.is_active_combined ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                        ${passenger.is_active_combined ? 'Active' : 'Inactive'}
                                    </span></p>
                                </div>
                                <div>
                                    <label class="text-sm text-gray-500">Total Rides</label>
                                    <p class="text-xl font-bold">${passengerRides.length}</p>
                                </div>
                                <div>
                                    <label class="text-sm text-gray-500">Joined Date</label>
                                    <p>${this.formatDateTime(passenger.user_created_at || passenger.passenger_created_at)}</p>
                                </div>
                            </div>
                            
                            ${passengerRides.length > 0 ? `
                                <div class="border-t pt-4">
                                    <h4 class="font-medium mb-2">Recent Rides</h4>
                                    <div class="space-y-2">
                                        ${passengerRides.slice(0, 5).map(ride => `
                                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                                <div>
                                                    <p class="font-medium">${this.formatDate(ride.createdAt)}</p>
                                                    <p class="text-sm text-gray-500">
                                                        ${ride.pickupLocation?.address || 'N/A'} â†’ 
                                                        ${ride.dropoffLocation?.address || 'N/A'}
                                                    </p>
                                                </div>
                                                <div class="text-right">
                                                    <span class="status-badge status-${ride.status}">
                                                        ${this.getStatusText(ride.status)}
                                                    </span>
                                                    <p class="font-medium mt-1">$${ride.finalFare ? ride.finalFare.toFixed(2) : '0.00'}</p>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                    
                    // Change modal title
                    document.querySelector('#ride-modal h3').textContent = 'Passenger Details';
                    document.getElementById('ride-modal').classList.remove('hidden');
                }

            async viewRideDetails(rideId) {
                   const ride = this.rides.find(r => r.id === rideId);
                   if (!ride) {
                       this.showNotification('Ride not found', 'error');
                       return;
                   }

                   // Find driver and passenger details
                   const driver = this.drivers.find(d => d.id === ride.driverId);
                   const passenger = this.passengers.find(p => p.id === ride.riderId);

                   const content = document.getElementById('ride-details-content');
                   
                   // Get ride type name
                   const rideType = this.rideTypes.find(rt => rt.id === ride.rideTypeId);
                   const rideTypeName = rideType ? rideType.name || rideType.id : ride.rideTypeId || 'N/A';
                   
                   content.innerHTML = `
                       <div class="space-y-4">
                           <!-- Ride Information -->
                           <div class="grid grid-cols-2 gap-4">
                               <div>
                                   <label class="text-sm text-gray-500">Ride ID</label>
                                   <p class="font-mono">${ride.id}</p>
                               </div>
                               <div>
                                   <label class="text-sm text-gray-500">Status</label>
                                   <p><span class="status-badge status-${ride.status}">${this.getStatusText(ride.status)}</span></p>
                               </div>
                           </div>
                           
                           <div class="grid grid-cols-2 gap-4">
                               <div>
                                   <label class="text-sm text-gray-500">Ride Type</label>
                                   <p class="font-medium">${rideTypeName}</p>
                               </div>
                               <div>
                                   <label class="text-sm text-gray-500">Payment Method</label>
                                   <p class="font-medium">${ride.paymentMethod || 'N/A'}</p>
                               </div>
                           </div>
                           
                           <!-- Passenger Information -->
                           <div class="border-t pt-4">
                               <h4 class="font-medium mb-2">Passenger Information</h4>
                               ${passenger ? `
                                   <div class="flex items-center space-x-3">
                                       <img src="${passenger.avatar || 'https://via.placeholder.com/32'}"
                                            alt="${passenger.full_name}"
                                            class="w-12 h-12 rounded-full">
                                       <div>
                                           <p class="font-medium">${passenger.full_name || 'Unknown'}</p>
                                           <p class="text-sm text-gray-500">${passenger.email || 'No email'}</p>
                                           <p class="text-sm text-gray-500">ID: ${ride.riderId}</p>
                                       </div>
                                   </div>
                               ` : `<p>ID: ${ride.riderId || 'N/A'}</p>`}
                           </div>
                           
                           <!-- Driver Information -->
                           <div class="border-t pt-4">
                               <h4 class="font-medium mb-2">Driver Information</h4>
                               ${driver ? `
                                   <div class="flex items-center space-x-3">
                                       <img src="${driver.profile_picture_url || 'https://via.placeholder.com/32'}"
                                            alt="${driver.full_name}"
                                            class="w-12 h-12 rounded-full">
                                       <div>
                                           <p class="font-medium">${driver.full_name || 'Unknown'}</p>
                                           <p class="text-sm text-gray-500">${driver.display_email || driver.email || 'No email'}</p>
                                           <p class="text-sm text-gray-500">ID: ${ride.driverId || 'N/A'}</p>
                                       </div>
                                   </div>
                               ` : '<p>No driver assigned</p>'}
                           </div>
                           
                           <!-- Ride Details -->
                           <div class="border-t pt-4">
                               <h4 class="font-medium mb-2">Ride Details</h4>
                               <div class="grid grid-cols-2 gap-4">
                                   <div>
                                       <label class="text-sm text-gray-500">Pickup Location</label>
                                       <p>${ride.pickupLocation?.address || ride.pickup?.name || 'N/A'}</p>
                                   </div>
                                   <div>
                                       <label class="text-sm text-gray-500">Dropoff Location</label>
                                       <p>${ride.dropoffLocation?.address || ride.dropoff?.name || 'N/A'}</p>
                                   </div>
                                   <div>
                                       <label class="text-sm text-gray-500">Distance</label>
                                       <p>${ride.distance ? (ride.distance / 1000).toFixed(1) + ' km' : 'N/A'}</p>
                                   </div>
                                   <div>
                                       <label class="text-sm text-gray-500">Duration</label>
                                       <p>${ride.duration ? Math.floor(ride.duration / 60) + ' min' : 'N/A'}</p>
                                   </div>
                               </div>
                           </div>
                           
                          <!-- Trip & Payment Information -->
                          <div class="border-t pt-4">
                              <h4 class="font-medium mb-4">Trip & Payment Status</h4>
                              
                              <!-- Trip Status -->
                              <div class="mb-4">
                                  <label class="text-sm text-gray-500 mb-2 block">Trip Status</label>
                                  <div class="flex items-center">
                                      <span class="status-badge status-${ride.status} text-lg px-4 py-2">
                                          <i class="fas fa-route mr-2"></i>
                                          ${this.getStatusText(ride.status)}
                                      </span>
                                  </div>
                              </div>
                              
                              <!-- Payment Information -->
                              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                  <div>
                                      <label class="text-sm text-gray-500">Final Fare</label>
                                      <p class="text-2xl font-bold text-gray-800">
                                          ${this.formatCurrency(ride.finalFare || 0, ride.paymentData?.currency || 'USD')}
                                      </p>
                                  </div>
                                  
                                  <div>
                                      <label class="text-sm text-gray-500">Payment Status</label>
                                      <div class="mt-1">
                                          ${ride.paymentData ? 
                                              ride.paymentStatus === 'paid' || ride.paymentStatus === 'CAPTURED' ? 
                                              '<span class="bg-green-100 text-green-800 px-3 py-2 rounded-lg flex items-center">' +
                                              '<i class="fas fa-check-circle mr-2"></i>Paid</span>' : 
                                              ride.paymentStatus === 'cancelled' || ride.paymentStatus === 'CANCELLED' ?
                                              '<span class="bg-gray-100 text-gray-800 px-3 py-2 rounded-lg flex items-center">' +
                                              '<i class="fas fa-ban mr-2"></i>Cancelled</span>' :
                                              ride.paymentStatus === 'pending' ?
                                              '<span class="bg-yellow-100 text-yellow-800 px-3 py-2 rounded-lg flex items-center">' +
                                              '<i class="fas fa-clock mr-2"></i>Pending</span>' :
                                              '<span class="bg-red-100 text-red-800 px-3 py-2 rounded-lg flex items-center">' +
                                              '<i class="fas fa-exclamation-circle mr-2"></i>' + (ride.paymentStatus || 'Unknown') + '</span>' :
                                              '<span class="bg-gray-100 text-gray-800 px-3 py-2 rounded-lg flex items-center">' +
                                              '<i class="fas fa-times-circle mr-2"></i>No Payment</span>'
                                          }
                                      </div>
                                  </div>
                                  
                                  <div>
                                      <label class="text-sm text-gray-500">Payment Method</label>
                                      <p class="mt-1">
                                          ${ride.paymentMethod ? 
                                              '<span class="bg-purple-100 text-purple-800 px-3 py-2 rounded-lg flex items-center">' +
                                              '<i class="fas ' + (ride.paymentMethod === 'cash' ? 'fa-money-bill' : 'fa-credit-card') + ' mr-2"></i>' +
                                              ride.paymentMethod.toUpperCase() + '</span>' : 
                                              '<span class="text-gray-500">N/A</span>'
                                          }
                                      </p>
                                  </div>
                              </div>
                              
                              <!-- Payment Amount -->
                              ${ride.paymentAmount > 0 ? `
                                  <div class="mt-4 grid grid-cols-2 gap-4">
                                      <div>
                                          <label class="text-sm text-gray-500">Payment Amount</label>
                                          <p class="text-xl font-bold text-green-600">
                                              ${this.formatCurrency(ride.paymentAmount, ride.paymentData?.currency || 'USD')}
                                          </p>
                                      </div>
                                      <div>
                                          <label class="text-sm text-gray-500">Payment Currency</label>
                                          <p class="font-medium">${ride.paymentData?.currency || 'N/A'}</p>
                                      </div>
                                  </div>
                              ` : ''}
                              
                              ${ride.paymentData ? `
                                  <div class="mt-4">
                                      <button onclick="dashboard.viewPaymentById('${ride.paymentId}')"
                                              class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 flex items-center">
                                          <i class="fas fa-receipt mr-2"></i>
                                          View Full Payment Details
                                      </button>
                                  </div>
                              ` : ''}
                          </div>
                           
                           <!-- Timestamps -->
                           <div class="border-t pt-4">
                               <h4 class="font-medium mb-2">Timestamps</h4>
                               <div class="space-y-1 text-sm">
                                   <p>Created: ${this.formatDateTime(ride.createdAt)}</p>
                                   ${ride.acceptedAt ? `<p>Accepted: ${this.formatDateTime(ride.acceptedAt)}</p>` : ''}
                                   ${ride.cancelledAt ? `<p>Cancelled: ${this.formatDateTime(ride.cancelledAt)}</p>` : ''}
                                   <p>Last Updated: ${this.formatDateTime(ride.updatedAt)}</p>
                               </div>
                           </div>
                       </div>
                   `;
                   
                   document.getElementById('ride-modal').classList.remove('hidden');
               }
            
            async viewDriverDetails(driverId) {
                   const driver = this.drivers.find(d => d.id === driverId);
                   if (!driver) {
                       this.showNotification('Driver not found', 'error');
                       return;
                   }

                   // Get driver's rides
                   const driverRides = this.rides.filter(ride => ride.driverId === driverId);
                   const completedRides = driverRides.filter(ride => ride.status === 'completed').length;
                   const cancelledRides = driverRides.filter(ride =>
                       ride.status === 'cancelledByDriver' || ride.status === 'cancelledByPassenger'
                   ).length;
                   const totalEarnings = driverRides
                       .filter(ride => ride.status === 'completed' && ride.finalFare)
                       .reduce((sum, ride) => sum + (ride.finalFare || 0), 0);

                   const content = document.getElementById('ride-details-content');
                   content.innerHTML = `
                       <div class="space-y-6">
                           <!-- Header Section -->
                           <div class="flex items-start justify-between">
                               <div class="flex items-center space-x-4">
                                   <img src="${driver.profile_picture_url || 'https://via.placeholder.com/100'}" 
                                        alt="${driver.full_name}" 
                                        class="w-24 h-24 rounded-full border-4 border-white shadow">
                                   <div>
                                       <h4 class="text-2xl font-bold">${driver.full_name || 'Unknown Driver'}</h4>
                                       <p class="text-gray-600">${driver.display_email || driver.email || 'No email'}</p>
                                       <p class="text-sm text-gray-500">ID: ${driver.id}</p>
                                       <p class="text-sm text-gray-500">Role: ${driver.role || 'driver'}</p>
                                   </div>
                               </div>
                               <div class="text-right">
                                   <span class="status-badge ${driver.is_active_combined ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'} text-lg px-4 py-2">
                                       ${driver.is_active_combined ? 'ACTIVE' : 'INACTIVE'}
                                   </span>
                                   <p class="text-sm text-gray-500 mt-2">${driver.billing_type || 'N/A'}</p>
                               </div>
                           </div>

                           <!-- Stats Grid -->
                           <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                               <div class="bg-blue-50 p-4 rounded-lg">
                                   <p class="text-sm text-blue-600">Total Rides</p>
                                   <p class="text-2xl font-bold">${driverRides.length}</p>
                               </div>
                               <div class="bg-green-50 p-4 rounded-lg">
                                   <p class="text-sm text-green-600">Completed</p>
                                   <p class="text-2xl font-bold">${completedRides}</p>
                               </div>
                               <div class="bg-red-50 p-4 rounded-lg">
                                   <p class="text-sm text-red-600">Cancelled</p>
                                   <p class="text-2xl font-bold">${cancelledRides}</p>
                               </div>
                               <div class="bg-purple-50 p-4 rounded-lg">
                                   <p class="text-sm text-purple-600">Total Earnings</p>
                                   <p class="text-2xl font-bold">$${totalEarnings.toFixed(2)}</p>
                               </div>
                           </div>

                           <!-- Account Information -->
                           <div class="border-t pt-4">
                               <h4 class="text-lg font-semibold mb-4">Account Information</h4>
                               <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                   <div>
                                       <label class="text-sm text-gray-500">Account Email</label>
                                       <p class="font-medium">${driver.email || 'N/A'}</p>
                                   </div>
                                   <div>
                                       <label class="text-sm text-gray-500">Account Phone</label>
                                       <p class="font-medium">${driver.phone || 'N/A'}</p>
                                   </div>
                                   <div>
                                       <label class="text-sm text-gray-500">Account Created</label>
                                       <p class="font-medium">${this.formatDateTime(driver.user_created_at)}</p>
                                   </div>
                                   <div>
                                       <label class="text-sm text-gray-500">Account Updated</label>
                                       <p class="font-medium">${this.formatDateTime(driver.user_updated_at)}</p>
                                   </div>
                               </div>
                           </div>

                           <!-- Personal Information -->
                           <div class="border-t pt-4">
                               <h4 class="text-lg font-semibold mb-4">Personal Information</h4>
                               <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                   <div>
                                       <label class="text-sm text-gray-500">Identity Number</label>
                                       <p class="font-medium">${driver.identity_number || 'N/A'}</p>
                                   </div>
                                   <div>
                                       <label class="text-sm text-gray-500">Phone Number</label>
                                       <p class="font-medium">${driver.phone_number || driver.phone || 'N/A'}</p>
                                   </div>
                                   <div>
                                       <label class="text-sm text-gray-500">Address</label>
                                       <p class="font-medium">${driver.address || 'N/A'}</p>
                                   </div>
                                   <div>
                                       <label class="text-sm text-gray-500">City/Country</label>
                                       <p class="font-medium">${driver.city || 'N/A'}, ${driver.country || 'N/A'} (${driver.country_code || 'N/A'})</p>
                                   </div>
                               </div>
                           </div>

                           <!-- Vehicle Information -->
                           <div class="border-t pt-4">
                               <h4 class="text-lg font-semibold mb-4">Vehicle Information</h4>
                               <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                   <div>
                                       <label class="text-sm text-gray-500">Vehicle</label>
                                       <p class="font-medium">${driver.selected_vehicle || 'N/A'} ${driver.selected_model || ''}</p>
                                   </div>
                                   <div>
                                       <label class="text-sm text-gray-500">Year</label>
                                       <p class="font-medium">${driver.selected_year || driver.year || 'N/A'}</p>
                                   </div>
                                   <div>
                                       <label class="text-sm text-gray-500">License Plate</label>
                                       <p class="font-medium">${driver.licence_plate || driver.license_plate || 'N/A'}</p>
                                   </div>
                                   <div>
                                       <label class="text-sm text-gray-500">Color</label>
                                       <p class="font-medium">${driver.vehicle_color || driver.color || 'N/A'}</p>
                                   </div>
                               </div>
                           </div>

                           <!-- Documents Section -->
                           ${driver.driver_license_front_url || driver.national_id_front_url ? `
                           <div class="border-t pt-4">
                               <h4 class="text-lg font-semibold mb-4">Documents & Licenses</h4>
                               <div class="space-y-3">
                                   ${driver.driver_license_front_url ? `
                                       <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                           <div>
                                               <p class="font-medium">Driver's License (Front)</p>
                                               <p class="text-sm text-gray-500">License verification</p>
                                           </div>
                                           <a href="${driver.driver_license_front_url}" target="_blank"
                                              class="text-blue-500 hover:text-blue-700">
                                               <i class="fas fa-external-link-alt mr-2"></i>View
                                           </a>
                                       </div>
                                   ` : ''}
                                   
                                   ${driver.national_id_front_url ? `
                                       <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                           <div>
                                               <p class="font-medium">National ID (Front)</p>
                                               <p class="text-sm text-gray-500">Identity verification</p>
                                           </div>
                                           <a href="${driver.national_id_front_url}" target="_blank"
                                              class="text-blue-500 hover:text-blue-700">
                                               <i class="fas fa-external-link-alt mr-2"></i>View
                                           </a>
                                       </div>
                                   ` : ''}
                                   
                                   ${driver.national_id_back_url ? `
                                       <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                           <div>
                                               <p class="font-medium">National ID (Back)</p>
                                               <p class="text-sm text-gray-500">Identity verification</p>
                                           </div>
                                           <a href="${driver.national_id_back_url}" target="_blank"
                                              class="text-blue-500 hover:text-blue-700">
                                               <i class="fas fa-external-link-alt mr-2"></i>View
                                           </a>
                                       </div>
                                   ` : ''}
                               </div>
                               
                               <!-- License Status -->
                               <div class="mt-4 grid grid-cols-2 gap-4">
                                   <div class="p-3 ${driver.have_vehicle_licenses ? 'bg-green-50' : 'bg-red-50'} rounded-lg">
                                       <p class="font-medium">Vehicle License</p>
                                       <p class="${driver.have_vehicle_licenses ? 'text-green-600' : 'text-red-600'}">
                                           ${driver.have_vehicle_licenses ? 'âœ“ Verified' : 'âœ— Missing'}
                                       </p>
                                   </div>
                                   <div class="p-3 ${driver.have_taxi_license ? 'bg-green-50' : 'bg-red-50'} rounded-lg">
                                       <p class="font-medium">Taxi License</p>
                                       <p class="${driver.have_taxi_license ? 'text-green-600' : 'text-red-600'}">
                                           ${driver.have_taxi_license ? 'âœ“ Verified' : 'âœ— Not Required'}
                                       </p>
                                   </div>
                               </div>
                           </div>
                           ` : ''}

                           <!-- Registration Status -->
                           <div class="border-t pt-4">
                               <h4 class="text-lg font-semibold mb-4">Registration Status</h4>
                               <div class="space-y-2">
                                   <div class="flex justify-between items-center">
                                       <span>Registration Completed</span>
                                       <span class="${driver.is_registeration_completed ? 'text-green-600' : 'text-yellow-600'}">
                                           ${driver.is_registeration_completed ? 'âœ“ Completed' : 'âœ— Pending'}
                                       </span>
                                   </div>
                                   <div class="flex justify-between items-center">
                                       <span>Driver Profile Created</span>
                                       <span class="text-gray-600">${this.formatDateTime(driver.driver_created_at)}</span>
                                   </div>
                                   <div class="flex justify-between items-center">
                                       <span>Driver Profile Updated</span>
                                       <span class="text-gray-600">${this.formatDateTime(driver.driver_updated_at)}</span>
                                   </div>
                               </div>
                           </div>

                           <!-- Recent Rides -->
                           ${driverRides.length > 0 ? `
                               <div class="border-t pt-4">
                                   <h4 class="text-lg font-semibold mb-4">Recent Rides</h4>
                                   <div class="space-y-3">
                                       ${driverRides.slice(0, 5).map(ride => `
                                           <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                               <div>
                                                   <p class="font-medium">${this.formatDate(ride.createdAt)}</p>
                                                   <p class="text-sm text-gray-500">
                                                       ${ride.pickupLocation?.address?.substring(0, 30) || 'Pickup'} â†’ 
                                                       ${ride.dropoffLocation?.address?.substring(0, 30) || 'Dropoff'}
                                                   </p>
                                               </div>
                                               <div class="text-right">
                                                   <span class="status-badge status-${ride.status}">
                                                       ${this.getStatusText(ride.status)}
                                                   </span>
                                                   <p class="font-medium mt-1">$${ride.finalFare ? ride.finalFare.toFixed(2) : '0.00'}</p>
                                               </div>
                                           </div>
                                       `).join('')}
                                   </div>
                                   ${driverRides.length > 5 ?
                                       `<p class="text-center text-blue-500 mt-2 cursor-pointer" 
                                           onclick="dashboard.viewDriverRides('${driver.id}')">
                                           View all ${driverRides.length} rides
                                       </p>` : ''
                                   }
                               </div>
                           ` : ''}

                           <!-- Action Buttons -->
                           <div class="border-t pt-4 flex justify-end space-x-3">
                               <button onclick="dashboard.verifyDriver('${driver.id}', ${driver.is_registeration_completed})" 
                                       class="px-4 py-2 ${driver.is_registeration_completed ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-green-500 hover:bg-green-600'} text-white rounded-lg">
                                   ${driver.is_registeration_completed ? 'Unverify' : 'Verify'} Driver
                               </button>
                               <button onclick="dashboard.sendMessageToDriver('${driver.id}', '${driver.display_email || driver.email}')" 
                                       class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg">
                                   <i class="fas fa-envelope mr-2"></i>Send Message
                               </button>
                           </div>
                       </div>
                   `;
                   
                   // Change modal title
                   document.querySelector('#ride-modal h3').textContent = 'Driver Details';
                   document.getElementById('ride-modal').classList.remove('hidden');
               }

            async userHasDriverSubcollection(userId) {
                   try {
                       const driverRef = collection(db, 'letsGoUser', userId, 'driver');
                       const snapshot = await getDocs(driverRef);
                       return !snapshot.empty;
                   } catch (error) {
                       console.error('Error checking driver subcollection:', error);
                       return false;
                   }
               }

               // Add helper method to check if user has passenger subcollection
               async userHasPassengerSubcollection(userId) {
                   try {
                       const passengerRef = collection(db, 'letsGoUser', userId, 'passenger');
                       const snapshot = await getDocs(passengerRef);
                       return !snapshot.empty;
                   } catch (error) {
                       console.error('Error checking passenger subcollection:', error);
                       return false;
                   }
               }
            
            async toggleDriverStatus(driverId, isCurrentlyActive) {
                   if (confirm(`Are you sure you want to ${isCurrentlyActive ? 'deactivate' : 'activate'} this driver?`)) {
                       try {
                           // Update user document
                           await db.collection('letsGoUser').doc(driverId)
                               .update({
                                   is_active: !isCurrentlyActive,
                                   updated_at: firebase.firestore.FieldValue.serverTimestamp()
                               });
                           
                           // Update driver subcollection if it exists
                           const driverRef = db.collection('letsGoUser').doc(driverId)
                               .collection('driver').doc(driverId);
                           
                           const driverDoc = await driverRef.get();
                           if (driverDoc.exists) {
                               await driverRef.update({
                                   is_active: !isCurrentlyActive,
                                   updated_at: firebase.firestore.FieldValue.serverTimestamp()
                               });
                           }
                           
                           this.showNotification(`Driver ${isCurrentlyActive ? 'deactivated' : 'activated'} successfully`);
                           await this.loadDrivers();
                           this.renderDriversTable();
                           this.updateDashboardStats();
                       } catch (error) {
                           console.error('Error updating driver status:', error);
                           this.showNotification('Error updating driver status', 'error');
                       }
                   }
               }

            async refundRide(rideId) {
                    if (confirm('Are you sure you want to process a refund for this ride?')) {
                        // Implement refund logic here
                        this.showNotification('Refund processed successfully');
                    }
                }
                
                async togglePassengerStatus(passengerId, isCurrentlyActive) {
                    if (confirm(`Are you sure you want to ${isCurrentlyActive ? 'deactivate' : 'activate'} this passenger?`)) {
                        try {
                            // Update user document
                            await db.collection('letsGoUser').doc(passengerId)
                                .update({
                                    is_active: !isCurrentlyActive,
                                    updated_at: firebase.firestore.FieldValue.serverTimestamp()
                                });
                            
                            // Update passenger subcollection if it exists
                            const passengerRef = db.collection('letsGoUser').doc(passengerId)
                                .collection('passenger').doc(passengerId);
                            
                            const passengerDoc = await passengerRef.get();
                            if (passengerDoc.exists) {
                                await passengerRef.update({
                                    is_active: !isCurrentlyActive,
                                    updated_at: firebase.firestore.FieldValue.serverTimestamp()
                                });
                            }
                            
                            this.showNotification(`Passenger ${isCurrentlyActive ? 'deactivated' : 'activated'} successfully`);
                            await this.loadPassengers();
                            this.renderPassengersTable();
                        } catch (error) {
                            console.error('Error updating passenger status:', error);
                            this.showNotification('Error updating passenger status', 'error');
                        }
                    }
                }

                getStatusText(status) {
                        const statusMap = {
                            'requested': 'Requested',
                            'accepted': 'Accepted',
                            'arrived': 'Driver has arrived',
                            'inProgress': 'Trip in progress',
                            'completed': 'Completed',
                            'cancelledByPassenger': 'Cancelled by passenger',
                            'cancelledByDriver': 'Cancelled by driver',
                            'timeout': 'Timeout'
                        };
                        return statusMap[status] || status;
                    }

                getCountryName(code) {
                        const countries = {
                            'EG': 'Egypt',
                            'SA': 'Saudi Arabia',
                            'AE': 'United Arab Emirates',
                            'QA': 'Qatar',
                            'KW': 'Kuwait'
                        };
                        return countries[code] || code;
                    }


                formatDate(date) {
                        if (!date) return 'N/A';
                        return date.toISOString().split('T')[0];
                    }

                    formatTime(date) {
                        if (!date) return 'N/A';
                        return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    }

                    formatDateTime(date) {
                        if (!date) return 'N/A';
                        return date.toLocaleString();
                    }

                    updateTime() {
                        const now = new Date();
                        document.getElementById('current-time').textContent =
                            now.toLocaleDateString() + ' ' + now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    }

                    setupEventListeners() {
                            // Navigation
                            document.querySelectorAll('nav a').forEach(link => {
                                link.addEventListener('click', (e) => {
                                    e.preventDefault();
                                    const section = link.getAttribute('href').substring(1);
                                    this.showSection(section);
                                });
                            });

                            // Filters
                            document.getElementById('status-filter').addEventListener('change', () => {
                                this.currentPage = 1;
                                this.renderRidesTable();
                            });

                            document.getElementById('date-filter').addEventListener('change', () => {
                                this.currentPage = 1;
                                this.renderRidesTable();
                            });
                            
                            const paymentStatusFilter = document.getElementById('payment-status-filter');
                            if (paymentStatusFilter) {
                                paymentStatusFilter.addEventListener('change', () => {
                                    this.renderPaymentsTable();
                                });
                            }

                            const paymentDateFilter = document.getElementById('payment-date-filter');
                            if (paymentDateFilter) {
                                paymentDateFilter.addEventListener('change', () => {
                                    this.renderPaymentsTable();
                                });
                            }
                            
                            const passengerSearch = document.getElementById('passenger-search');
                            if (passengerSearch) {
                                passengerSearch.addEventListener('input', () => {
                                    this.renderPassengersTable();
                                });
                            }
                            
                            const driverSearch = document.getElementById('driver-search');
                            if (driverSearch) {
                                driverSearch.addEventListener('input', () => {
                                    this.renderDriversTable();
                                });
                            }

                            const driverStatusFilter = document.getElementById('driver-status-filter');
                            if (driverStatusFilter) {
                                driverStatusFilter.addEventListener('change', () => {
                                    this.renderDriversTable();
                                });
                            }
                        }

                    getCurrencyName(currencyCode) {
                        const currencyNames = {
                            'USD': 'US Dollar',
                            'EUR': 'Euro',
                            'GBP': 'British Pound',
                            'EGP': 'Egyptian Pound',
                            'SAR': 'Saudi Riyal',
                            'AED': 'UAE Dirham',
                            'QAR': 'Qatari Riyal',
                            'KWD': 'Kuwaiti Dinar'
                        };
                        
                        return currencyNames[currencyCode] || currencyCode || 'Unknown Currency';
                    }
                    
                        showSection(section) {
                            // Hide all sections
                            document.getElementById('dashboard-section').style.display = 'none';
                            document.getElementById('rides-section').style.display = 'none';
                            document.getElementById('drivers-section').style.display = 'none';
                            document.getElementById('passengers-section').style.display = 'none';
                            document.getElementById('settings-section').style.display = 'none';
                            document.getElementById('payments-section').style.display = 'none';
                            
                            // Show selected section
                            switch(section) {
                                case 'dashboard':
                                    document.getElementById('dashboard-section').style.display = 'block';
                                    document.getElementById('page-title').textContent = 'Dashboard Overview';
                                    break;
                                case 'rides':
                                    document.getElementById('rides-section').style.display = 'block';
                                    document.getElementById('page-title').textContent = 'Rides Management';
                                    break;
                                case 'drivers':
                                    document.getElementById('drivers-section').style.display = 'block';
                                    document.getElementById('page-title').textContent = 'Drivers Management';
                                    this.renderDriversTable();
                                    break;
                                case 'passengers':
                                    document.getElementById('passengers-section').style.display = 'block';
                                    document.getElementById('page-title').textContent = 'Passengers Management';
                                    this.renderPassengersTable();
                                    break;
                                case 'settings':
                                    document.getElementById('settings-section').style.display = 'block';
                                    document.getElementById('page-title').textContent = 'App Settings';
                                    break;
                                case 'payments':
                                    document.getElementById('payments-section').style.display = 'block';
                                    document.getElementById('page-title').textContent = 'Payment Management';
                                    this.renderPaymentsTable(); // You'll need to create this method
                                    break;
                                default:
                                    document.getElementById('dashboard-section').style.display = 'block';
                                    document.getElementById('page-title').textContent = 'Dashboard Overview';
                            }
                            
                            // Update active nav link
                            document.querySelectorAll('nav a').forEach(link => {
                                const linkSection = link.getAttribute('href').substring(1);
                                if (linkSection === section) {
                                    link.classList.add('bg-blue-50', 'text-blue-600');
                                } else {
                                    link.classList.remove('bg-blue-50', 'text-blue-600');
                                }
                            });
                        }

                        showNotification(message, type = 'success') {
                            // Create notification element
                            const notification = document.createElement('div');
                            notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 transform transition-transform duration-300 ${
                                type === 'success' ? 'bg-green-500' : 'bg-red-500'
                            } text-white`;
                            notification.textContent = message;
                            
                            document.body.appendChild(notification);
                            
                            // Remove notification after 3 seconds
                            setTimeout(() => {
                                notification.style.transform = 'translateX(100%)';
                                setTimeout(() => notification.remove(), 300);
                            }, 3000);
                        }
        }
            

        // Global dashboard instance
        const dashboard = new DashboardManager();

        // Utility functions
        function nextPage() {
            const filteredRides = dashboard.filterRides();
            const totalPages = Math.ceil(filteredRides.length / dashboard.pageSize);
            if (dashboard.currentPage < totalPages) {
                dashboard.currentPage++;
                dashboard.renderRidesTable();
            }
        }

        function previousPage() {
            if (dashboard.currentPage > 1) {
                dashboard.currentPage--;
                dashboard.renderRidesTable();
            }
        }

        function closeModal() {
            document.getElementById('ride-modal').classList.add('hidden');
        }

        function exportRides() {
            const filteredRides = dashboard.filterRides();
            const csv = convertToCSV(filteredRides);
            downloadCSV(csv, 'rides_export.csv');
        }

        function convertToCSV(data) {
            const headers = ['ID', 'Passenger ID', 'Driver Name', 'Status', 'Fare', 'Distance', 'Date'];
            const rows = data.map(ride => [
                ride.id,
                ride.riderId || '',
                ride.driver?.first_name || '',
                dashboard.getStatusText(ride.status),
                ride.finalFare || 0,
                `${(ride.distance / 1000).toFixed(1)} km`,
                dashboard.formatDate(ride.createdAt)
            ]);
            
            return [headers, ...rows]
                .map(row => row.map(cell => `"${cell}"`).join(','))
                .join('\n');
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', filename);
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                window.location.reload();
            }
        }

        async function refreshAppConfig() {
            await dashboard.loadAppConfig();
            dashboard.renderSupportedCountries();
            dashboard.showNotification('Configuration refreshed');
        }

        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', () => {
            dashboard.initialize();
        });

        // Close modal on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
            }
        });

        // Close modal on background click
        document.getElementById('ride-modal').addEventListener('click', (e) => {
            if (e.target.id === 'ride-modal') {
                closeModal();
            }
        });
    </script>
</body>
</html>
